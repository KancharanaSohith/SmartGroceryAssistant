<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grocery Reorder Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dynamic Brown-Based Color System */
        :root {
            --primary-brown: #8B4513;
            --secondary-brown: #D2691E;
            --accent-brown: #F5F5DC;
            --dark-brown: #654321;
            --light-brown: #DEB887;
            
            /* Light mode colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #e1e5e9;
            --shadow-color: rgba(0,0,0,0.08);
            --card-bg: #ffffff;
        }

        /* Dark mode colors */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #aaaaaa;
            --border-color: #404040;
            --shadow-color: rgba(0,0,0,0.3);
            --card-bg: #2d2d2d;
        }

        /* Header with Dynamic Colors */
        .header {
            background: linear-gradient(135deg, var(--primary-brown) 0%, var(--secondary-brown) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.5s ease;
        }

        /* Category-specific header colors */
        .header.dairy {
            background: linear-gradient(135deg, #FFF8DC 0%, #DEB887 100%);
            color: var(--dark-brown);
        }

        .header.produce {
            background: linear-gradient(135deg, var(--primary-brown) 0%, #228B22 100%);
        }

        .header.bakery {
            background: linear-gradient(135deg, #D2B48C 0%, #FFD700 100%);
            color: var(--dark-brown);
        }

        .header.pantry {
            background: linear-gradient(135deg, #800020 0%, var(--dark-brown) 100%);
        }

        .header.frozen {
            background: linear-gradient(135deg, #4682B4 0%, #F0F8FF 100%);
            color: var(--dark-brown);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            background: white;
            color: var(--primary-brown);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Account Switcher */
        .account-switcher {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-account {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .current-account:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .account-dropdown {
            position: relative;
            display: inline-block;
        }

        .account-dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 350px; /* Increased from 280px to show full names */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            right: 0;
            margin-top: 5px;
        }

        .account-dropdown-content.show {
            display: block;
        }

        .account-dropdown-content {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #ddd #f5f5f5;
        }

        .account-dropdown-content::-webkit-scrollbar {
            width: 6px;
        }

        .account-dropdown-content::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 3px;
        }

        .account-dropdown-content::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .account-dropdown-content::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }

        .loading-personas {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .loading-personas .loading-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .persona-section {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .persona-section-title {
            padding: 10px 20px;
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .custom-persona-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            margin: 5px 10px;
        }

        .custom-persona-item:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }

        .account-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
            font-size: 14px;
            line-height: 1.4;
        }

        .account-option:last-child {
            border-bottom: none;
        }

        .account-option:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        .account-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .account-option.active:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .persona-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0; /* Allow text to wrap */
        }

        .persona-name {
            font-weight: 600;
            margin-bottom: 2px;
            /* Remove text truncation - let names be fully visible */
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .persona-details {
            font-size: 12px;
            color: inherit;
            opacity: 0.8;
            /* Remove text truncation - let details be fully visible */
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .persona-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .delivery-promise {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Search Bar */
        .search-section {
            background: var(--card-bg);
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 15px 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            border-color: var(--primary-brown);
            background: white;
            box-shadow: 0 0 0 4px rgba(139, 69, 19, 0.1);
        }

        .search-icon {
            color: #666;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 1rem;
            outline: none;
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        /* Order Status Bar */
        .order-status-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 20px 20px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.5s ease-out;
            overflow: hidden;
        }

        .order-status-content {
            display: flex;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .order-status-icon {
            font-size: 2rem;
            margin-right: 15px;
            animation: pulse 2s infinite;
        }

        .order-status-text {
            flex: 1;
        }

        .order-status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .order-status-details {
            font-size: 0.95rem;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .order-status-timer {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            min-width: 80px;
            text-align: center;
        }

        .order-status-bar.grace-period {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        
        .order-status-bar.grace-period::before {
            content: "‚è∞ Grace Period Active";
            position: absolute;
            top: 5px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .order-status-bar.eta-display {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }

        .order-status-bar.delivering {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            box-shadow: 0 8px 25px rgba(255, 167, 38, 0.3);
        }
        
        .order-status-bar.delivering::before {
            content: "üöö Out for Delivery";
            position: absolute;
            top: 5px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .order-status-bar.delivered {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            box-shadow: 0 8px 25px rgba(102, 187, 106, 0.3);
        }

        /* Order Status Badges */
        .order-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-status-badge.placed {
            background: #e3f2fd;
            color: #1976d2;
        }

        .order-status-badge.confirmed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .order-status-badge.preparing {
            background: #fff3e0;
            color: #f57c00;
        }

        .order-status-badge.out_for_delivery {
            background: #e8f5e8;
            color: #388e3c;
        }

        .order-status-badge.delivering {
            background: #fff8e1;
            color: #f9a825;
        }

        .order-status-badge.delivered {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .order-status-badge.cancelled {
            background: #ffebee;
            color: #d32f2f;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Category Navigation */
        .categories-section {
            padding: 20px;
            margin-bottom: 20px;
        }

        .categories-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .category-card {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #ff6b35;
        }

        .category-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .category-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        /* Stats Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 4px solid #ff6b35;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ff6b35;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
            border: 2px solid transparent;
        }

        .tab.active {
            background: #ff6b35;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .tab:hover:not(.active) {
            background: #f8f9fa;
            color: #333;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary-brown) 0%, var(--secondary-brown) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-success {
            background: #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Product Cards */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-brown) 0%, var(--secondary-brown) 100%);
        }

        .product-card.high::before {
            background: #dc3545;
        }

        .product-card.medium::before {
            background: #ffc107;
        }

        .product-card.low::before {
            background: #28a745;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .product-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .product-category {
            background: #f8f9fa;
            color: #666;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .product-details {
            margin-bottom: 20px;
        }

        .product-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-detail:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            font-weight: 700;
            color: #333;
        }

        /* Urgency Badge */
        .urgency-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .urgency-badge.high {
            background: #f8d7da;
            color: #721c24;
        }

        .urgency-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .urgency-badge.low {
            background: #d4edda;
            color: #155724;
        }

        /* Alerts */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-icon {
            font-size: 3rem;
            color: #ff6b35;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* AI Training Animation */
        .ai-training-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin: 10px 0;
        }

        .training-dot {
            font-size: 12px;
            transition: all 0.3s ease;
            opacity: 0.3;
            color: #ccc;
        }

        .training-dot.active {
            opacity: 1;
            color: #ff6b35;
            transform: scale(1.2);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .logo-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Quick Commerce Features */
        .quick-features {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            overflow-x: auto;
            padding: 10px 0;
        }

        .quick-feature {
            background: white;
            padding: 15px 20px;
            border-radius: 25px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-feature:hover {
            border-color: #ff6b35;
            transform: translateY(-2px);
        }

        .quick-feature.active {
            background: #ff6b35;
            color: white;
            border-color: #ff6b35;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark-brown);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--primary-brown);
        }

        .modal-body {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* Cart Items Scrolling */
        #cart-items {
            max-height: none;
            overflow: visible;
            padding-right: 5px;
            margin-bottom: 20px;
        }

        /* Custom scrollbar for modal body */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Custom scrollbar for cart items */
        #cart-items::-webkit-scrollbar {
            width: 6px;
        }

        #cart-items::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #cart-items::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #cart-items::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Cart item styling */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .cart-item:hover {
            background-color: #f8f9fa;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .cart-item-details {
            font-size: 0.9rem;
            color: #666;
        }

        .item-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            color: white;
        }

        .item-badge.new {
            background: #28a745;
        }

        .item-badge.reorder {
            background: #007bff;
        }

        .cart-remove-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            cursor: pointer;
            border: none;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-remove-btn:hover {
            background-color: #c82333;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }

        .cart-remove-btn:active {
            transform: scale(0.95);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Cart Summary - Fixed at bottom */
        .cart-summary {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Ensure cart items take available space */
        .cart-items-container {
            flex: 0 0 auto;
            position: relative;
            margin-bottom: 20px;
        }


        /* Cart Icon */
        .cart-icon {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .cart-icon:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .cart-count {
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 5px;
            min-width: 18px;
            display: inline-block;
            text-align: center;
        }

        /* Notification Icon */
        .notification-icon {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-left: 10px;
        }

        .notification-icon:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .notification-count {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 5px;
            min-width: 18px;
            display: inline-block;
            text-align: center;
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            overflow: hidden;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-brown) 0%, var(--secondary-brown) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .notification-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .notification-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .notification-item.high-priority {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .notification-message {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #888;
        }

        .notification-priority {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-medium {
            background: #fff3cd;
            color: #856404;
        }

        .priority-low {
            background: #d4edda;
            color: #155724;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-left: 10px;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Items Grid for Add Item */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .item-box {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item-box:hover {
            border-color: var(--primary-brown);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.15);
        }

        .item-box.selected {
            border-color: var(--primary-brown);
            background: linear-gradient(135deg, var(--accent-brown) 0%, white 100%);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.2);
        }

        .item-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            margin: 0 auto 15px;
            display: block;
            object-fit: cover;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

                 .item-unit {
             font-size: 0.8rem;
             color: #666;
             background: #f8f9fa;
             padding: 4px 8px;
             border-radius: 12px;
             display: inline-block;
         }
         
         .category-badge {
             font-size: 0.7rem;
             color: #888;
             background: #f0f0f0;
             padding: 3px 6px;
             border-radius: 8px;
             display: inline-block;
             margin: 5px 0;
         }

        .custom-persona-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-persona-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.2s ease;
        }

        .delete-persona-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Ensure persona names are always visible */
        .persona-name {
            color: inherit;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .persona-details {
            color: inherit;
            font-size: 12px;
            line-height: 1.2;
            opacity: 0.85;
        }

        /* Active state improvements */
        .account-option.active .persona-name {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .account-option.active .persona-details {
            opacity: 0.9;
        }

        /* Hover state improvements */
        .account-option:hover .persona-name {
            color: #333;
        }

        .account-option:hover .persona-details {
            opacity: 1;
        }

        /* Custom persona styling */
        .custom-persona-item .persona-name {
            color: white;
        }

        .custom-persona-item .persona-details {
            color: rgba(255,255,255,0.9);
        }

        .custom-persona-item:hover .persona-name,
        .custom-persona-item:hover .persona-details {
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">üõí</div>
                <div class="logo-text">
                    <h1>Smart Grocery</h1>
                    <p>AI-Powered Reorder Assistant</p>
                </div>
            </div>
            <div class="account-switcher">
                <div class="account-dropdown">
                    <div class="current-account" onclick="toggleAccountDropdown()">
                        üë§ Rahul
                    </div>
                    <div class="account-dropdown-content" id="account-dropdown">
                        <!-- Personas will be loaded dynamically -->
                        <div class="loading-personas">
                            <div class="loading-icon">‚è≥</div>
                            <div>Loading personas...</div>
                        </div>
                    </div>
                </div>
                                 <div class="delivery-promise" id="ai-status">
                     ü§ñ AI Training Active
                 </div>
                 <div class="cart-icon" onclick="toggleCart()">
                     üõí <span class="cart-count" id="cart-count">0</span>
                 </div>
                 <div class="notification-icon" onclick="toggleNotifications()">
                     üîî <span class="notification-count" id="notification-count">0</span>
                 </div>
                 <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                     üåô
                 </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" placeholder="Search for groceries, items, or categories..." id="search-input">
        </div>
    </div>

    <!-- Order Status Display -->
    <div id="orderStatusBar" class="order-status-bar" style="display: none;">
        <div class="order-status-content">
            <div class="order-status-icon">üì¶</div>
            <div class="order-status-text">
                <div class="order-status-title" id="orderStatusTitle">Order Status</div>
                <div class="order-status-details" id="orderStatusDetails">Loading...</div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
            <div class="order-status-timer" id="orderStatusTimer">--:--</div>
                <button onclick="cancelCurrentOrder()" class="btn btn-danger" style="padding: 8px 12px; font-size: 0.8rem; border-radius: 6px;">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Categories -->
    <div class="categories-section">
        <h2 class="categories-title">Shop by Category</h2>
                 <div class="categories-grid">
             <div class="category-card" onclick="filterByCategory('all')">
                 <span class="category-icon">üõçÔ∏è</span>
                 <div class="category-name">All</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Dairy')">
                 <span class="category-icon">ü•õ</span>
                 <div class="category-name">Dairy</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Bakery')">
                 <span class="category-icon">üçû</span>
                 <div class="category-name">Bakery</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Produce')">
                 <span class="category-icon">ü•¨</span>
                 <div class="category-name">Produce</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Pantry')">
                 <span class="category-icon">ü•´</span>
                 <div class="category-name">Pantry</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Frozen')">
                 <span class="category-icon">üßä</span>
                 <div class="category-name">Frozen</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Beverages')">
                 <span class="category-icon">ü•§</span>
                 <div class="category-name">Beverages</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Snacks')">
                 <span class="category-icon">üçø</span>
                 <div class="category-name">Snacks</div>
             </div>
             <div class="category-card" onclick="filterByCategory('Household')">
                 <span class="category-icon">üßΩ</span>
                 <div class="category-name">Household</div>
             </div>
         </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
                 <!-- Quick Features -->
                   <div class="quick-features">
              <div class="quick-feature active" onclick="showTab('dashboard')">üìä Dashboard</div>
              <div class="quick-feature" onclick="showTab('add-item')">‚ûï Add Item</div>
              <div class="quick-feature" onclick="showTab('predictions')">ü§ñ AI Predictions</div>
              <div class="quick-feature" onclick="showTab('manage')">üìù Manage Items</div>
              <div class="quick-feature" onclick="showTab('order-history')">üìã Order History</div>
              <div class="quick-feature" onclick="showTab('recommendations')">üçÇ Recommendations</div>
              <div class="quick-feature" onclick="showTab('shopping-list')">üìù Smart List</div>
              <div class="quick-feature" onclick="showTab('smart-baskets')">üõçÔ∏è Smart Baskets</div>
              <div class="quick-feature" onclick="toggleCart()">üõí View Cart (<span id="cart-count-quick">0</span>)</div>
              <div class="quick-feature" onclick="toggleBudgetModal()">üí∞ Budget</div>
              <div class="quick-feature" onclick="createUrgentNotifications()">üîî Create Alerts</div>
          </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="total-items">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="urgent-items">0</div>
                    <div class="stat-label">Urgent Reorders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ai-trained">No</div>
                    <div class="stat-label">AI Trained</div>
                </div>
            </div>

            <!-- Test Scenarios Button -->
            <div style="text-align: center; margin-bottom: 25px;">
                <button onclick="createUrgentScenarios()" class="btn btn-secondary" style="margin: 0 10px;">
                    üö® Create Urgent Scenarios (Test)
                </button>
                <button onclick="refreshDashboard()" class="btn" style="margin: 0 10px;">
                    üîÑ Refresh Dashboard
                </button>
            </div>

            <div class="product-card">
                <h3 style="margin-bottom: 20px; color: #333;">üö® Urgent Items (Need Reorder Soon)</h3>
                <div id="urgent-list" class="products-grid">
                    <div class="loading">
                        <div class="loading-icon">‚è≥</div>
                        <div>Loading urgent items...</div>
                    </div>
                </div>
            </div>

            <div class="product-card">
                <h3 style="margin-bottom: 20px; color: #333;">üìä Recent AI Predictions</h3>
                <div id="recent-predictions" class="products-grid">
                    <div class="loading">
                        <div class="loading-icon">ü§ñ</div>
                        <div>Loading predictions...</div>
                    </div>
                </div>
            </div>
        </div>

                 <!-- Add Item Tab -->
         <div id="add-item" class="tab-content">
             <div class="product-card">
                 <h3 style="margin-bottom: 25px; color: #333;">‚ûï Add New Grocery Item</h3>
                 
                 <!-- Current Category Display -->
                 <div class="form-group">
                     <label>Current Category</label>
                     <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-brown);">
                         <div style="font-size: 1rem; color: #333; margin-bottom: 8px;">
                             <strong>Selected:</strong> <span id="current-category-display">All Categories</span>
                         </div>
                         <div style="font-size: 0.9rem; color: #666;">
                             Items shown below are filtered by this category. Change category from "Shop by Category" above.
                         </div>
                     </div>
                 </div>
                 
                 <!-- Item Grid (Shows items based on selected category) -->
                 <div id="item-grid">
                     <h4 style="margin-bottom: 20px; color: #666;">Click on an item to add it:</h4>
                     <div id="category-items" class="items-grid"></div>
                 </div>
                 
                 <!-- Add Item Form (Hidden until item selected) -->
                 <div id="add-item-form-container" style="display: none;">
                     <h4 style="margin-bottom: 20px; color: #666;">Add Item Details:</h4>
                     <form id="add-item-form">
                         <div class="form-group">
                             <label for="item-name">Item Name</label>
                             <input type="text" id="item-name" required readonly>
                         </div>
                         
                         <div class="form-group">
                             <label for="item-brand">Brand (Optional)</label>
                             <input type="text" id="item-brand" placeholder="e.g., Amul, Britannia, Local">
                         </div>
                         
                         <div class="form-group">
                             <label for="item-quantity">Quantity</label>
                             <div style="display: flex; gap: 10px; align-items: center;">
                                 <input type="number" id="item-quantity" step="0.1" min="0.1" required placeholder="e.g., 2.5" style="flex: 1;">
                                 <span id="quantity-unit" style="font-weight: 600; color: #666; min-width: 60px;">kg</span>
                             </div>
                         </div>
                         
                         <div class="form-group">
                             <label for="ai-info">ü§ñ AI Smart Detection</label>
                             <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-brown);">
                                 <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                     <strong>Current Persona:</strong> <span id="current-persona-display">Rahul (Single)</span>
                                 </div>
                                 <div style="font-size: 0.85rem; color: #888;">
                                     AI will automatically detect your household size from consumption patterns and adapt over time.
                                 </div>
                             </div>
                         </div>
                         
                                                   <div class="form-actions">
                              <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                  <strong>Choose your action:</strong><br>
                                  üõí <strong>Add to Cart</strong> - Buy immediately | ü§ñ <strong>Add to AI Grocery List</strong> - Track consumption patterns
                              </p>
                              <button type="button" onclick="resetAddItemForm()" class="btn btn-secondary">üîÑ Select Different Item</button>
                              <button type="button" onclick="addSelectedItemToCart()" class="btn btn-success">üõí Add to Cart</button>
                              <button type="submit" class="btn">ü§ñ Add to AI Grocery List</button>
                          </div>
                     </form>
                 </div>
             </div>
         </div>

        <!-- Predictions Tab -->
        <div id="predictions" class="tab-content">
            <div class="product-card">
                <h3 style="margin-bottom: 25px; color: #333;">ü§ñ AI Predictions & Smart Recommendations</h3>
                <button onclick="refreshPredictions()" class="btn">üîÑ Refresh Predictions</button>
                <div id="predictions-list" class="products-grid" style="margin-top: 25px;">
                    <div class="loading">
                        <div class="loading-icon">ü§ñ</div>
                        <div>Loading AI predictions...</div>
                    </div>
                </div>
            </div>
        </div>

                 <!-- Manage Items Tab -->
         <div id="manage" class="tab-content">
             <div class="product-card">
                 <h3 style="margin-bottom: 25px; color: #333;">üìù Manage Your Grocery Items</h3>
                 <div id="items-list" class="products-grid">
                     <div class="loading">
                         <div class="loading-icon">üìã</div>
                         <div>Loading items...</div>
                     </div>
                 </div>
             </div>
         </div>

                   <!-- Order History Tab -->
          <div id="order-history" class="tab-content">
              <div class="product-card">
                  <h3 style="margin-bottom: 25px; color: #333;">üìã Order History & Tracking</h3>
                  
                  <!-- AI Learning Section -->
                  <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid var(--primary-brown);">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                          <div>
                              <h4 style="margin: 0 0 8px 0; color: #333;">üß† AI Learning & Improvement</h4>
                              <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                  The AI automatically learns from your actions (orders, deletions, updates) to improve predictions. 
                                  No manual training needed - it's always learning! üöÄ
                              </p>
                          </div>
                          <button onclick="showAILearningStatus()" class="btn" style="white-space: nowrap;">
                              üìä Show AI Learning Status
                          </button>
                      </div>
                      <div id="ai-learning-status" style="display: none;">
                          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                              <div id="ai-learning-message" style="color: #666;"></div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Order Deletion Learning Notice -->
                  <div id="deletion-learning-notice" style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 15px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                          <span style="font-size: 1.2rem;">üß†</span>
                          <div>
                              <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">AI Learning in Progress</div>
                              <div style="font-size: 0.9rem; color: #856404;">
                                  The AI is learning from your recent order deletion to improve future predictions. 
                                  This helps the system understand your preferences better.
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div id="order-history-list" class="products-grid">
                      <div class="loading">
                          <div class="loading-icon">üìã</div>
                          <div>Loading order history...</div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Recommendations Tab -->
          <div id="recommendations" class="tab-content">
              <div class="product-card">
                  <h3 style="margin-bottom: 25px; color: #333;">üçÇ Smart Recommendations & Trending Items</h3>
                  
                  <!-- Recommendation Filters -->
                  <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                      <button onclick="loadRecommendations('seasonal')" class="btn" id="seasonal-btn">üçÇ Seasonal</button>
                      <button onclick="loadRecommendations('trending')" class="btn btn-secondary" id="trending-btn">üìà Trending</button>
                      <button onclick="loadRecommendations('smart')" class="btn btn-secondary" id="smart-btn">üß† Smart</button>
                      <button onclick="loadRecommendations('all')" class="btn btn-secondary" id="all-btn">üåü All</button>
                  </div>
                  
                  <!-- Seasonal Recommendations -->
                  <div id="seasonal-recommendations" style="display: none;">
                      <h4 style="margin-bottom: 20px; color: #333;">üçÇ Seasonal Recommendations</h4>
                      <div id="seasonal-content" class="products-grid">
                          <div class="loading">
                              <div class="loading-icon">üçÇ</div>
                              <div>Loading seasonal recommendations...</div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Trending Recommendations -->
                  <div id="trending-recommendations" style="display: none;">
                      <h4 style="margin-bottom: 20px; color: #333;">üìà Trending Items</h4>
                      <div id="trending-content" class="products-grid">
                          <div class="loading">
                              <div class="loading-icon">üìà</div>
                              <div>Loading trending items...</div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Smart Recommendations -->
                  <div id="smart-recommendations" style="display: none;">
                      <h4 style="margin-bottom: 20px; color: #333;">üß† Personalized Smart Recommendations</h4>
                      <div id="smart-content" class="products-grid">
                          <div class="loading">
                              <div class="loading-icon">üß†</div>
                              <div>Loading smart recommendations...</div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- All Recommendations -->
                  <div id="all-recommendations">
                      <h4 style="margin-bottom: 20px; color: #333;">üåü All Recommendations</h4>
                      <div id="all-content" class="products-grid">
                          <div class="loading">
                              <div class="loading-icon">üåü</div>
                              <div>Loading all recommendations...</div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Smart Shopping List Tab -->
          <div id="shopping-list" class="tab-content">
              <div class="product-card">
                  <h3 style="margin-bottom: 25px; color: #333;">üìù Smart Shopping List Generator</h3>
                  
                  <!-- List Generation Controls -->
                  <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
                      <button onclick="generateSmartShoppingList()" class="btn" id="generate-list-btn">üõí Generate Smart List</button>
                      <button onclick="generateMealPlan()" class="btn btn-secondary" id="meal-plan-btn">üçΩÔ∏è Meal Plan</button>
                      <div style="display: flex; align-items: center; gap: 10px;">
                          <label for="days-ahead" style="font-weight: 600; color: #333;">Days ahead:</label>
                          <select id="days-ahead" style="padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 8px;">
                              <option value="3">3 days</option>
                              <option value="7" selected>7 days</option>
                              <option value="14">14 days</option>
                              <option value="30">30 days</option>
                          </select>
                      </div>
                  </div>
                  
                  <!-- Shopping List Content -->
                  <div id="shopping-list-content">
                      <div class="loading">
                          <div class="loading-icon">üìù</div>
                          <div>Click "Generate Smart List" to create your personalized shopping list</div>
                      </div>
                  </div>
                  
                  <!-- Meal Plan Content -->
                  <div id="meal-plan-content" style="display: none;">
                      <div class="loading">
                          <div class="loading-icon">üçΩÔ∏è</div>
                          <div>Click "Meal Plan" to generate weekly meal suggestions</div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Smart Baskets Tab -->
          <div id="smart-baskets" class="tab-content">
              <div class="product-card">
                  <h3 style="margin-bottom: 25px; color: #333;">üõçÔ∏è AI-Managed Smart Baskets</h3>
                  
                  <!-- Smart Basket Controls -->
                  <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
                      <button onclick="showCreateBasketModal()" class="btn" id="create-basket-btn">‚ûï Create Smart Basket</button>
                      <button onclick="checkAutoAddItems()" class="btn btn-secondary" id="check-auto-btn">ü§ñ Check Auto-Add</button>
                      <button onclick="loadSmartBaskets()" class="btn btn-secondary" id="refresh-baskets-btn">üîÑ Refresh</button>
                  </div>
                  
                  <!-- Smart Baskets Content -->
                  <div id="smart-baskets-content">
                      <div class="loading">
                          <div class="loading-icon">üõçÔ∏è</div>
                          <div>Loading your smart baskets...</div>
                      </div>
                  </div>
              </div>
          </div>

                 <!-- Custom Persona Modal -->
         <div id="custom-persona-modal" class="modal" style="display: none;">
             <div class="modal-content">
                 <div class="modal-header">
                     <h3>‚ûï Create Custom Persona</h3>
                     <span class="close" onclick="closeCustomPersonaModal()">&times;</span>
                 </div>
                 <div class="modal-body">
                     <form id="custom-persona-form">
                         <div class="form-group">
                             <label for="persona-name">Persona Name</label>
                             <input type="text" id="persona-name" required placeholder="e.g., John, Sarah & Mike, The Smith Family">
                         </div>
                         <div class="form-group">
                             <label for="persona-email">Email</label>
                             <input type="email" id="persona-email" required placeholder="persona@example.com">
                         </div>
                         <div class="form-group">
                             <label for="persona-description">Description (Optional)</label>
                             <input type="text" id="persona-description" placeholder="e.g., Young professional, Student, etc.">
                         </div>
                         <div class="form-actions">
                             <button type="button" onclick="closeCustomPersonaModal()" class="btn btn-secondary">Cancel</button>
                             <button type="submit" class="btn">Create Persona</button>
                         </div>
                     </form>
                 </div>
             </div>
         </div>

                   <!-- Shopping Cart Modal -->
          <div id="shopping-cart-modal" class="modal" style="display: none;" onclick="closeCart()">
              <div class="modal-content" onclick="event.stopPropagation()">
                  <div class="modal-header">
                      <h3>üõí Shopping Cart</h3>
                      <span class="close" onclick="closeCart()">&times;</span>
                  </div>
                  <div class="modal-body">
                      <div class="cart-items-container">
                          <div id="cart-items">
                              <div class="loading">
                                  <div class="loading-icon">üõí</div>
                                  <div>Your cart is empty</div>
                              </div>
                          </div>
                              </div>
                      <div class="cart-summary" id="cart-summary" style="display: none; flex-shrink: 0; margin-top: auto;">
                          <div class="cart-total" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                              <strong>Total Items: <span id="cart-total-items">0</span></strong>
                          </div>
                          <div class="form-actions">
                              <button type="button" onclick="clearCart()" class="btn btn-danger">üóëÔ∏è Clear Cart</button>
                              <button type="button" onclick="closeCart()" class="btn btn-secondary">Continue Shopping</button>
                              <button type="button" onclick="placeCartOrderNew()" class="btn btn-success">üõí Place Order</button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Edit Item Modal -->
          <div id="edit-item-modal" class="modal" style="display: none;">
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>‚úèÔ∏è Edit Grocery Item</h3>
                      <span class="close" onclick="closeEditItemModal()">&times;</span>
                  </div>
                  <div class="modal-body">
                      <form id="edit-item-form">
                          <div class="form-group">
                              <label for="edit-item-name">Item Name</label>
                              <input type="text" id="edit-item-name" required readonly>
                          </div>
                          <div class="form-group">
                              <label for="edit-item-category">Category</label>
                              <input type="text" id="edit-item-category" required readonly>
                          </div>
                          <div class="form-group">
                              <label for="edit-item-quantity">Current Quantity</label>
                              <div style="display: flex; gap: 10px; align-items: center;">
                                  <input type="number" id="edit-item-quantity" step="0.1" min="0" required style="flex: 1;">
                                  <span id="edit-quantity-unit" style="font-weight: 600; color: #666; min-width: 60px;">kg</span>
                              </div>
                          </div>
                          <div class="form-group">
                              <label for="edit-item-consumption">Consumption Rate (per day)</label>
                              <input type="number" id="edit-item-consumption" step="0.01" min="0" required>
                          </div>
                          <div class="form-group">
                              <label for="edit-item-brand">Brand</label>
                              <input type="text" id="edit-item-brand" placeholder="e.g., Amul, Britannia, Local">
                          </div>
                          <div class="form-actions">
                              <button type="button" onclick="closeEditItemModal()" class="btn btn-secondary">Cancel</button>
                              <button type="submit" class="btn">üíæ Save Changes</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- Notification Panel -->
          <div id="notification-panel" class="notification-panel">
              <div class="notification-header">
                  <h3>üîî Notifications</h3>
                  <button class="notification-close" onclick="closeNotifications()">&times;</button>
              </div>
              <div class="notification-content" id="notification-content">
                  <div class="loading">
                      <div class="loading-icon">üîî</div>
                      <div>Loading notifications...</div>
                  </div>
              </div>
          </div>

          <!-- Budget Management Modal -->
          <div id="budget-modal" class="modal" style="display: none;">
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>üí∞ Budget Management</h3>
                      <span class="close" onclick="closeBudgetModal()">&times;</span>
                  </div>
                  <div class="modal-body">
                      <div id="budget-status" style="margin-bottom: 25px;">
                          <div class="loading">
                              <div class="loading-icon">üí∞</div>
                              <div>Loading budget status...</div>
                          </div>
                      </div>
                      
                      <form id="budget-form">
                          <div class="form-group">
                              <label for="budget-amount">Monthly Budget (‚Çπ)</label>
                              <input type="number" id="budget-amount" step="0.01" min="0" required placeholder="Enter your monthly grocery budget">
                          </div>
                          <div class="form-group">
                              <label for="budget-category">Category (Optional)</label>
                              <select id="budget-category">
                                  <option value="">General Budget</option>
                                  <option value="Dairy">Dairy</option>
                                  <option value="Produce">Produce</option>
                                  <option value="Pantry">Pantry</option>
                                  <option value="Bakery">Bakery</option>
                                  <option value="Frozen">Frozen</option>
                              </select>
                          </div>
                          <div class="form-actions">
                              <button type="button" onclick="closeBudgetModal()" class="btn btn-secondary">Cancel</button>
                              <button type="submit" class="btn">üí∞ Set Budget</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- Create Smart Basket Modal -->
          <div id="create-basket-modal" class="modal" style="display: none;">
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>üõçÔ∏è Create Smart Basket</h3>
                      <span class="close" onclick="closeCreateBasketModal()">&times;</span>
                  </div>
                  <div class="modal-body">
                      <form id="create-basket-form">
                          <div class="form-group">
                              <label for="basket-item">Select Item</label>
                              <select id="basket-item" required>
                                  <option value="">Loading available items...</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label for="basket-name">Basket Name</label>
                              <input type="text" id="basket-name" required placeholder="e.g., Daily Essentials, Weekly Staples">
                          </div>
                          <div class="form-group">
                              <label for="reorder-threshold">Reorder Threshold (days before empty)</label>
                              <input type="number" id="reorder-threshold" step="0.5" min="0.5" max="30" value="3" required>
                          </div>
                          <div class="form-group">
                              <label for="min-quantity">Minimum Quantity to Maintain</label>
                              <input type="number" id="min-quantity" step="0.1" min="0.1" value="1" required>
                          </div>
                          <div class="form-group">
                              <label for="max-quantity">Maximum Quantity to Order</label>
                              <input type="number" id="max-quantity" step="0.1" min="0.1" value="5" required>
                          </div>
                          <div class="form-actions">
                              <button type="button" onclick="closeCreateBasketModal()" class="btn btn-secondary">Cancel</button>
                              <button type="submit" class="btn">üõçÔ∏è Create Basket</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>

          <!-- Edit Smart Basket Modal -->
          <div id="edit-basket-modal" class="modal" style="display: none;">
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>‚úèÔ∏è Edit Smart Basket</h3>
                      <span class="close" onclick="closeEditBasketModal()">&times;</span>
                  </div>
                  <div class="modal-body">
                      <form id="edit-basket-form">
                          <input type="hidden" id="edit-basket-id">
                          <div class="form-group">
                              <label for="edit-basket-name">Basket Name</label>
                              <input type="text" id="edit-basket-name" required>
                          </div>
                          <div class="form-group">
                              <label for="edit-auto-reorder">
                                  <input type="checkbox" id="edit-auto-reorder" style="margin-right: 8px;">
                                  Enable Auto-Reorder
                              </label>
                          </div>
                          <div class="form-group">
                              <label for="edit-reorder-threshold">Reorder Threshold (days before empty)</label>
                              <input type="number" id="edit-reorder-threshold" step="0.5" min="0.5" max="30" required>
                          </div>
                          <div class="form-group">
                              <label for="edit-min-quantity">Minimum Quantity to Maintain</label>
                              <input type="number" id="edit-min-quantity" step="0.1" min="0.1" required>
                          </div>
                          <div class="form-group">
                              <label for="edit-max-quantity">Maximum Quantity to Order</label>
                              <input type="number" id="edit-max-quantity" step="0.1" min="0.1" required>
                          </div>
                          <div class="form-actions">
                              <button type="button" onclick="closeEditBasketModal()" class="btn btn-secondary">Cancel</button>
                              <button type="submit" class="btn">üíæ Save Changes</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
    </div>

    <script>
                 let currentTab = 'dashboard';
         let currentCategory = 'all';
         let currentUser = 'rahul_single';
         let currentUserId = 1;
         let shoppingCart = []; // Shopping cart for items
         let currentItems = []; // Store current items for editing

        // Account switching and dynamic colors
        async function switchAccount(accountType) {
            currentUser = accountType;
            
            // Find the persona in our loaded list
            const persona = allPersonas.find(p => p.username === accountType);
            
            if (persona) {
                // Update account display with persona info
                const displayName = persona.display_name;
                const householdSize = persona.household_size;
                const icon = persona.username.startsWith('custom_') ? 'üë§' : getPersonaIcon(persona.username);
                
                document.querySelector('.current-account').textContent = `${icon} ${displayName}`;
                
                // Update persona display in Add Item form
                updatePersonaDisplay(accountType);
                
                // Close dropdown
                closeAccountDropdown();
                
                // Load user data
                await loadUserData(accountType);
                
                // Update active state in dropdown
                updateActivePersonaInDropdown(accountType);
            } else {
                console.error('Persona not found:', accountType);
                showAlert('Persona not found. Please refresh the page.', 'error');
            }
        }

        function updateActivePersonaInDropdown(activeUsername) {
            // Remove active class from all options
            const allOptions = document.querySelectorAll('.account-option');
            allOptions.forEach(option => option.classList.remove('active'));
            
            // Add active class to current persona
            const activeOption = document.querySelector(`[onclick*="${activeUsername}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
        }

        // Refresh persona list (useful for debugging or manual refresh)
        async function refreshPersonaList() {
            try {
                await loadAllPersonas();
                showAlert('Persona list refreshed! üîÑ', 'success');
            } catch (error) {
                console.error('Error refreshing personas:', error);
                showAlert('Error refreshing persona list', 'error');
            }
        }

        // Add refresh button to persona dropdown
        function addRefreshButton() {
            const dropdown = document.getElementById('account-dropdown');
            const refreshButton = document.createElement('div');
            refreshButton.className = 'account-option';
            refreshButton.style.cssText = 'background: #f8f9fa; color: #666; font-style: italic; cursor: pointer;';
            refreshButton.innerHTML = 'üîÑ Refresh Persona List';
            refreshButton.onclick = refreshPersonaList;
            
            // Insert before the "Add Custom Persona" button
            const addButton = dropdown.querySelector('[onclick*="showCustomPersonaForm"]');
            if (addButton) {
                dropdown.insertBefore(refreshButton, addButton);
            }
        }

        function toggleAccountDropdown() {
            const dropdown = document.getElementById('account-dropdown');
            dropdown.classList.toggle('show');
        }

                 function closeAccountDropdown() {
             const dropdown = document.getElementById('account-dropdown');
             dropdown.classList.remove('show');
         }
         
         function updatePersonaDisplay(accountType) {
             const personaDisplay = document.getElementById('current-persona-display');
             if (personaDisplay) {
                 const displayNames = {
                     'rahul_single': 'Rahul (Single)',
                     'priya_amit_couple': 'Priya & Amit (Couple)',
                     'patel_family': 'The Patel Family (4 people)',
                     'sharma_joint_family': 'Sharma Joint Family (6 people)',
                     'student_hostel_delhi': 'Delhi Student Hostel (8 people)'
                 };
                 personaDisplay.textContent = displayNames[accountType] || 'Custom Persona';
             }
         }
         
         function updateCategoryDisplay(category) {
             const categoryDisplay = document.getElementById('current-category-display');
             if (categoryDisplay) {
                 const displayNames = {
                     'all': 'All Categories',
                     'Dairy': 'ü•õ Dairy & Milk Products',
                     'Bakery': 'üçû Bakery & Bread',
                     'Produce': 'ü•¨ Fruits & Vegetables',
                     'Pantry': 'ü•´ Pantry & Staples',
                     'Frozen': 'üßä Frozen Foods',
                     'Beverages': 'ü•§ Beverages',
                     'Snacks': 'üçø Snacks & Chips',
                     'Household': 'üßΩ Household & Cleaning'
                 };
                 categoryDisplay.textContent = displayNames[category] || 'All Categories';
             }
         }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('account-dropdown');
            const currentAccount = document.querySelector('.current-account');
            
            if (!currentAccount.contains(event.target) && !dropdown.contains(event.target)) {
                closeAccountDropdown();
            }
        });

        function loadUserData(accountType) {
            // Create or get user from backend
            createOrGetUser(accountType);
        }

        async function createOrGetUser(accountType) {
            try {
                // First try to get existing user
                const usersResponse = await fetch(`${API_BASE}/users/`);
                const users = await usersResponse.json();
                
                let user = users.find(u => u.username === accountType);
                
                if (!user) {
                    // Create new user
                    const userData = {
                        username: accountType,
                        display_name: getDisplayName(accountType),
                        email: `${accountType}@test.com`,
                        household_size: getHouseholdSize(accountType),
                        account_type: accountType,
                        description: getDescription(accountType)
                    };
                    
                    const createResponse = await fetch(`${API_BASE}/users/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                    
                    if (createResponse.ok) {
                        user = await createResponse.json();
                    }
                }
                
                if (user) {
                    currentUserId = user.id;
                    console.log('User loaded:', user);
                    console.log('Current user ID:', currentUserId);
                    console.log('Current tab:', currentTab);
                    
                    // Load test data for this user
                    console.log('Loading test data for user:', user.id);
                    const testDataResponse = await fetch(`${API_BASE}/users/${user.id}/load-test-data`, { method: 'POST' });
                    if (testDataResponse.ok) {
                        const testData = await testDataResponse.json();
                        console.log('Test data loaded:', testData);
                    } else {
                        console.error('Failed to load test data');
                    }
                    
                    // Reload current tab
                    console.log('Reloading current tab:', currentTab);
                    if (currentTab === 'dashboard') {
                        loadDashboard();
                    } else if (currentTab === 'predictions') {
                        loadPredictions();
                    } else if (currentTab === 'manage') {
                        loadItems();
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('Error loading user data', 'error');
            }
        }

        function getHouseholdSize(accountType) {
            const sizes = {
                'rahul_single': 1,
                'priya_amit_couple': 2,
                'patel_family': 4,
                'sharma_joint_family': 6,
                'student_hostel_delhi': 8
            };
            return sizes[accountType] || 1;
        }

        function getDisplayName(accountType) {
            const names = {
                'rahul_single': 'Rahul',
                'priya_amit_couple': 'Priya & Amit',
                'patel_family': 'The Patel Family',
                'sharma_joint_family': 'Sharma Joint Family',
                'student_hostel_delhi': 'Delhi Student Hostel'
            };
            return names[accountType] || 'Custom Persona';
        }

        function getDescription(accountType) {
            const descriptions = {
                'rahul_single': 'Young professional living alone',
                'priya_amit_couple': 'Young married couple',
                'patel_family': 'Family with 2 kids',
                'sharma_joint_family': 'Joint family with grandparents',
                'student_hostel_delhi': 'Student hostel with 8 roommates'
            };
            return descriptions[accountType] || 'Custom persona';
        }

        // Custom Persona Functions
        function showCustomPersonaForm() {
            document.getElementById('custom-persona-modal').style.display = 'flex';
            closeAccountDropdown();
        }

        function closeCustomPersonaModal() {
            document.getElementById('custom-persona-modal').style.display = 'none';
            document.getElementById('custom-persona-form').reset();
        }

        async function createCustomPersona() {
            const name = document.getElementById('persona-name').value;
            const email = document.getElementById('persona-email').value;
            const description = document.getElementById('persona-description').value;
            
            if (!name || !email) {
                showAlert('Persona Name and Email are required.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/custom-persona/?display_name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const newPersona = await response.json();
                    
                    showAlert(`Custom persona "${name}" created successfully! üéâ`, 'success');
                    closeCustomPersonaModal();
                    
                    // Refresh persona list and switch to the new persona
                    await loadAllPersonas();
                    switchAccount(newPersona.username);
                    
                } else if (response.status === 409) {
                    // Handle conflict: user with this email already exists
                    const errorDetails = await response.json();
                    handleExistingUserConflict(errorDetails.detail, name, email);

                } else {
                    const error = await response.json();
                    showAlert(`Error creating custom persona: ${error.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error creating custom persona:', error);
                showAlert('An unexpected error occurred while creating the persona.', 'error');
            }
        }

        async function handleExistingUserConflict(details, newName, newEmail) {
            if (details.is_active) {
                showAlert(`This email is already in use by the active persona "${details.display_name}". Please use a different email.`, 'error');
                return;
            }

            // Inactive user exists, ask user if they want to reactivate or create a new one
            const confirmationMessage = `An account for "${details.display_name}" already exists with this email but is currently inactive.\n\nDo you want to reactivate this account?`;
            
            if (confirm(confirmationMessage)) {
                // YES: Reactivate the old account
                try {
                    const reactivateResponse = await fetch(`${API_BASE}/users/${details.user_id}/reactivate`, { method: 'POST' });
                    if (reactivateResponse.ok) {
                        const reactivatedUser = await reactivateResponse.json();
                        showAlert(`Persona "${reactivatedUser.display_name}" has been reactivated!`, 'success');
                        closeCustomPersonaModal();
                        await loadAllPersonas();
                        switchAccount(reactivatedUser.username);
                    } else {
                        throw new Error('Failed to reactivate persona.');
                    }
                } catch (error) {
                    showAlert('Error reactivating persona. Please try again.', 'error');
                }
            } else {
                // NO: Permanently delete the old account and create a new one
                const deleteConfirmation = `Are you sure? This will permanently delete all data for "${details.display_name}" (items, order history, etc.). This action cannot be undone.`;
                if (confirm(deleteConfirmation)) {
                    try {
                        // First, permanently delete the old user
                        const deleteResponse = await fetch(`${API_BASE}/users/${details.user_id}/permanent`, { method: 'DELETE' });
                        if (!deleteResponse.ok) {
                            throw new Error('Failed to delete the old persona.');
                        }
                        showAlert(`Old persona "${details.display_name}" has been permanently deleted.`, 'success');

                        // Now, create the new persona as requested
                        await createCustomPersona(); 

                    } catch (error) {
                        showAlert(`Error creating new persona: ${error.message}`, 'error');
                    }
                }
            }
        }

        function updateHeaderColor(category) {
            const header = document.querySelector('.header');
            
            // Remove all category classes
            header.classList.remove('dairy', 'produce', 'bakery', 'pantry', 'frozen');
            
            // Add category-specific class
            if (category && category !== 'all') {
                header.classList.add(category.toLowerCase());
            }
        }

                 // Show tab content
         function showTab(tabName) {
             // Hide all tab contents
             document.querySelectorAll('.tab-content').forEach(content => {
                 content.classList.remove('active');
             });
             
             // Remove active class from all quick features
             document.querySelectorAll('.quick-feature').forEach(feature => {
                 feature.classList.remove('active');
             });
             
             // Show selected tab content
             document.getElementById(tabName).classList.add('active');
             
             // Add active class to selected quick feature
             event.target.classList.add('active');
             
             currentTab = tabName;
             
             // Load data for the tab
             if (tabName === 'dashboard') {
                 loadDashboard();
             } else if (tabName === 'predictions') {
                 loadPredictions();
             } else if (tabName === 'manage') {
                 loadItems();
             } else if (tabName === 'order-history') {
                 loadOrderHistory();
             } else if (tabName === 'add-item') {
                 loadCategoryItems(); // Load items for current category
             } else if (tabName === 'recommendations') {
                 loadRecommendations('all'); // Load all recommendations by default
             } else if (tabName === 'shopping-list') {
                 // Reset to shopping list view
                 document.getElementById('shopping-list-content').style.display = 'block';
                 document.getElementById('meal-plan-content').style.display = 'none';
             } else if (tabName === 'smart-baskets') {
                 loadSmartBaskets(); // Load smart baskets
             }
         }

                 // Filter by category
         function filterByCategory(category) {
             currentCategory = category;
             
             // Update header color based on category
             updateHeaderColor(category);
             
             // Update active category styling
             document.querySelectorAll('.category-card').forEach(card => {
                 card.style.borderColor = card.querySelector('.category-name').textContent === category ? 'var(--primary-brown)' : 'transparent';
             });
             
             // Update category display in Add Item tab
             updateCategoryDisplay(category);
             
             // Always load category items when category changes
             loadCategoryItems();
             
             // Reload current tab with filtered data
             if (currentTab === 'dashboard') {
                 loadDashboard();
             } else if (currentTab === 'predictions') {
                 loadPredictions();
             } else if (currentTab === 'manage') {
                 loadItems();
             }
         }

        // API base URL
        const API_BASE = 'http://localhost:8000';

        // Loading state management
        function showLoadingState(section) {
            const loadingStates = {
                'dashboard': {
                    urgent: document.getElementById('urgent-list'),
                    predictions: document.getElementById('recent-predictions')
                },
                'predictions': {
                    predictions: document.getElementById('predictions-list')
                },
                'manage': {
                    items: document.getElementById('items-list')
                },
                'order-history': {
                    orders: document.getElementById('order-history-list')
                }
            };
            
            const sections = loadingStates[section];
            if (sections) {
                Object.values(sections).forEach(element => {
                    if (element) {
                        element.innerHTML = `
                            <div class="loading">
                                <div class="loading-icon">ü§ñ</div>
                                <div>AI is analyzing your data...</div>
                                <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                                    <div class="ai-training-indicator">
                                        <span class="training-dot">‚óè</span>
                                        <span class="training-dot">‚óè</span>
                                        <span class="training-dot">‚óè</span>
                                    </div>
                                    <div>Real-time AI training in progress...</div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
        }

        // AI Training indicator animation
        function startAITrainingAnimation() {
            const indicators = document.querySelectorAll('.ai-training-indicator');
            indicators.forEach(indicator => {
                const dots = indicator.querySelectorAll('.training-dot');
                let currentDot = 0;
                
                const animate = () => {
                    dots.forEach((dot, index) => {
                        dot.style.opacity = index === currentDot ? '1' : '0.3';
                        dot.style.color = index === currentDot ? '#ff6b35' : '#ccc';
                    });
                    currentDot = (currentDot + 1) % dots.length;
                };
                
                animate();
                const interval = setInterval(animate, 500);
                
                // Store interval for cleanup
                indicator.dataset.interval = interval;
            });
        }

        function stopAITrainingAnimation() {
            const indicators = document.querySelectorAll('.ai-training-indicator');
            indicators.forEach(indicator => {
                if (indicator.dataset.interval) {
                    clearInterval(indicator.dataset.interval);
                    delete indicator.dataset.interval;
                }
            });
        }

        // Update AI status in header
        function updateAIStatus(status) {
            const aiStatus = document.getElementById('ai-status');
            if (aiStatus) {
                const statuses = {
                    'training': 'ü§ñ AI Training Active',
                    'learning': 'üß† AI Learning Patterns',
                    'analyzing': 'üìä AI Analyzing Data',
                    'ready': '‚úÖ AI Ready',
                    'idle': 'ü§ñ AI Standby'
                };
                aiStatus.textContent = statuses[status] || statuses['idle'];
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            // Show loading state
            showLoadingState('dashboard');
            startAITrainingAnimation();
            updateAIStatus('analyzing');
            
            try {
                const [items, predictions] = await Promise.all([
                    fetch(`${API_BASE}/items/${currentUserId}`).then(res => res.json()),
                    fetch(`${API_BASE}/predictions/${currentUserId}`).then(res => res.json())
                ]);

                // Filter by category if selected
                let filteredItems = items;
                let filteredPredictions = predictions;
                
                if (currentCategory !== 'all') {
                    filteredItems = items.filter(item => item.category === currentCategory);
                    filteredPredictions = predictions.filter(p => p.category === currentCategory);
                }

                // Update stats
                document.getElementById('total-items').textContent = filteredItems.length;
                
                const urgentItems = filteredPredictions.filter(p => p.urgency_level === 'high');
                document.getElementById('urgent-items').textContent = urgentItems.length;
                
                document.getElementById('ai-trained').textContent = filteredItems.length >= 5 ? 'Yes' : 'No';

                // Show urgent items (completely unique items)
                const urgentList = document.getElementById('urgent-list');
                if (urgentItems.length === 0) {
                    urgentList.innerHTML = '<div class="loading"><div class="loading-icon">üéâ</div><div>No urgent items! You\'re all set!</div></div>';
                } else {
                // Filter out ordered items during grace period
                const filteredUrgentItems = filterOrderedItems(urgentItems);
                
                // Get completely unique urgent items (no duplicates by name)
                const uniqueUrgentItems = getCompletelyUniqueItems(filteredUrgentItems, 6);
                
                // Show info if items were filtered out due to being ordered
                const hiddenCount = urgentItems.length - filteredUrgentItems.length;
                if (hiddenCount > 0 && currentOrder && currentOrder.is_grace_period_active) {
                    const hiddenInfo = `<div style="background: #d1ecf1; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #17a2b8; font-size: 0.9rem; color: #0c5460;">
                        <strong>üì¶ ${hiddenCount} item${hiddenCount > 1 ? 's' : ''} hidden</strong> - Already ordered and in grace period
                    </div>`;
                    urgentList.innerHTML = hiddenInfo + urgentList.innerHTML;
                }
                    
                    // Show category diversity info
                    const categories = [...new Set(uniqueUrgentItems.map(item => item.category))];
                    const diversityInfo = categories.length > 1 ? 
                        `<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745; box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);">
                            <div style="font-weight: 600; color: #28a745; margin-bottom: 8px; font-size: 1.1rem;">üö® Urgent Items Across ${categories.length} Categories</div>
                            <div style="font-size: 0.95rem; color: #666; margin-bottom: 5px;">Items running low from different categories</div>
                            <div style="font-size: 0.9rem; color: #888; font-style: italic;">${categories.join(' ‚Ä¢ ')}</div>
                        </div>` : '';
                    
                    urgentList.innerHTML = diversityInfo + uniqueUrgentItems.map(item => `
                         <div class="product-card ${item.urgency_level}">
                             <div class="product-header">
                                 <div>
                                     <div class="product-title">${item.item_name}</div>
                                     <div class="product-category">${item.category}</div>
                                 </div>
                                 <span class="urgency-badge ${item.urgency_level}">${item.urgency_level}</span>
                             </div>
                             <div class="product-details">
                                 <div class="product-detail">
                                     <span class="detail-label">Current:</span>
                                     <span class="detail-value">${item.current_quantity} ${item.unit}</span>
                                 </div>
                                 <div class="product-detail">
                                     <span class="detail-label">Days until empty:</span>
                                     <span class="detail-value">${item.days_until_empty.toFixed(1)}</span>
                                 </div>
                             </div>
                             <div style="margin-top: 20px; display: flex; gap: 10px;">
                                 <button onclick="addToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="btn">üõí Add to Cart</button>
                                 <button onclick="quickOrder(${item.item_id}, ${item.suggested_quantity})" class="btn btn-success" style="display: none;">‚ö° Quick Order</button>
                             </div>
                         </div>
                     `).join('');
                }

                // Show recent predictions (completely unique items, excluding urgent items)
                const recentPredictions = document.getElementById('recent-predictions');
                const nonUrgentItems = filteredPredictions.filter(p => p.urgency_level !== 'high');
                
                // Filter out ordered items during grace period
                const filteredNonUrgentItems = filterOrderedItems(nonUrgentItems);
                const uniqueRecentItems = getCompletelyUniqueItems(filteredNonUrgentItems, 6);
                
                if (uniqueRecentItems.length === 0) {
                    recentPredictions.innerHTML = '<div class="loading"><div class="loading-icon">üìä</div><div>No predictions available yet. Add some items first!</div></div>';
                } else {
                    // Show category diversity info for recent predictions
                    const recentCategories = [...new Set(uniqueRecentItems.map(item => item.category))];
                    const recentDiversityInfo = recentCategories.length > 1 ? 
                        `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107; box-shadow: 0 2px 4px rgba(255, 193, 7, 0.1);">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 8px; font-size: 1.1rem;">üìä Recent Predictions Across ${recentCategories.length} Categories</div>
                            <div style="font-size: 0.95rem; color: #666; margin-bottom: 5px;">AI recommendations from different categories</div>
                            <div style="font-size: 0.9rem; color: #888; font-style: italic;">${recentCategories.join(' ‚Ä¢ ')}</div>
                        </div>` : '';
                    
                    recentPredictions.innerHTML = recentDiversityInfo + uniqueRecentItems.map(item => `
                         <div class="product-card ${item.urgency_level}">
                             <div class="product-header">
                                 <div>
                                     <div class="product-title">${item.item_name}</div>
                                     <div class="product-category">${item.category}</div>
                                 </div>
                                 <span class="urgency-badge ${item.urgency_level}">${item.urgency_level}</span>
                             </div>
                             <div class="product-details">
                                 <div class="product-detail">
                                     <span class="detail-label">Days until empty:</span>
                                     <span class="detail-value">${item.days_until_empty.toFixed(1)}</span>
                                 </div>
                                 <div class="product-detail">
                                     <span class="detail-label">Order by:</span>
                                     <span class="detail-value">${new Date(item.recommended_order_date).toLocaleDateString()}</span>
                                 </div>
                             </div>
                             <div style="margin-top: 20px; display: flex; gap: 10px;">
                                 <button onclick="addToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="btn">üõí Add to Cart</button>
                                 <button onclick="quickOrder(${item.item_id}, ${item.suggested_quantity})" class="btn btn-success" style="display: none;">‚ö° Quick Order</button>
                             </div>
                         </div>
                     `).join('');
                }

                // Stop AI training animation after data is loaded
                setTimeout(() => {
                    stopAITrainingAnimation();
                    updateAIStatus('ready');
                }, 1000);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Error loading dashboard data', 'error');
                stopAITrainingAnimation();
                updateAIStatus('idle');
            }
        }

        // Create Urgent Scenarios for Testing
        async function createUrgentScenarios() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                
                // Show loading state
                button.textContent = 'üö® Creating...';
                button.disabled = true;
                
                const response = await fetch(`${API_BASE}/users/${currentUserId}/simulate-urgent-scenarios`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    showAlert(`‚úÖ ${result.message}\n\nüö® Check the Dashboard for urgent items that need immediate reordering!`, 'success');
                    
                    // Refresh dashboard to show new urgent items
                    setTimeout(() => {
                        loadDashboard();
                    }, 1000);
                    
                } else {
                    throw new Error('Failed to create urgent scenarios');
                }
                
            } catch (error) {
                console.error('Error creating urgent scenarios:', error);
                showAlert('Error creating urgent scenarios', 'error');
            } finally {
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Refresh Dashboard
        function refreshDashboard() {
            loadDashboard();
            showAlert('Dashboard refreshed! üîÑ', 'success');
        }

        // Load predictions
        async function loadPredictions() {
            // Show loading state
            showLoadingState('predictions');
            startAITrainingAnimation();
            
            try {
                const response = await fetch(`${API_BASE}/predictions/${currentUserId}`);
                const predictions = await response.json();

                // Filter by category if selected
                let filteredPredictions = predictions;
                if (currentCategory !== 'all') {
                    filteredPredictions = predictions.filter(p => p.category === currentCategory);
                }
                
                // Filter out ordered items during grace period
                filteredPredictions = filterOrderedItems(filteredPredictions);

                const predictionsList = document.getElementById('predictions-list');
                if (filteredPredictions.length === 0) {
                    predictionsList.innerHTML = '<div class="loading"><div class="loading-icon">ü§ñ</div><div>No predictions available. Add some grocery items first!</div></div>';
                    return;
                }

                // Get completely unique items for better variety
                const uniquePredictions = getCompletelyUniqueItems(filteredPredictions, 12); // Show more items in predictions tab
                
                // Show category diversity info for predictions tab
                const predictionCategories = [...new Set(uniquePredictions.map(item => item.category))];
                const predictionDiversityInfo = predictionCategories.length > 1 ? 
                    `<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);">
                        <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px; font-size: 1.1rem;">ü§ñ AI Predictions Across ${predictionCategories.length} Categories</div>
                        <div style="font-size: 0.95rem; color: #666; margin-bottom: 5px;">Smart recommendations from different categories for better variety</div>
                        <div style="font-size: 0.9rem; color: #888; font-style: italic;">${predictionCategories.join(' ‚Ä¢ ')}</div>
                    </div>` : '';

                predictionsList.innerHTML = predictionDiversityInfo + uniquePredictions.map(item => `
                    <div class="product-card ${item.urgency_level}">
                        <div class="product-header">
                            <div>
                                <div class="product-title">${item.item_name}</div>
                                <div class="product-category">${item.category}</div>
                            </div>
                            <span class="urgency-badge ${item.urgency_level}">${item.urgency_level}</span>
                        </div>
                        <div class="product-details">
                            <div class="product-detail">
                                <span class="detail-label">Current Quantity:</span>
                                <span class="detail-value">${item.current_quantity} ${item.unit}</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Days until empty:</span>
                                <span class="detail-value">${item.days_until_empty.toFixed(1)}</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Recommended order date:</span>
                                <span class="detail-value">${new Date(item.recommended_order_date).toLocaleDateString()}</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Suggested quantity:</span>
                                <span class="detail-value">${item.suggested_quantity.toFixed(1)} ${item.unit}</span>
                            </div>
                        </div>
                                                 <div style="margin-top: 20px; display: flex; gap: 10px;">
                             <button onclick="addToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="btn">üõí Add to Cart</button>
                         </div>
                    </div>
                `).join('');

                // Stop AI training animation after data is loaded
                setTimeout(() => {
                    stopAITrainingAnimation();
                }, 1000);

            } catch (error) {
                console.error('Error loading predictions:', error);
                showAlert('Error loading predictions', 'error');
                stopAITrainingAnimation();
            }
        }

                 // Load items for management
         async function loadItems() {
             // Show loading state
             showLoadingState('manage');
             startAITrainingAnimation();
             
             try {
                 const response = await fetch(`${API_BASE}/items/${currentUserId}`);
                 const items = await response.json();

                 // Store items for editing
                 currentItems = items;

                 // Filter by category if selected
                 let filteredItems = items;
                 if (currentCategory !== 'all') {
                     filteredItems = items.filter(item => item.category === currentCategory);
                 }

                 const itemsList = document.getElementById('items-list');
                 if (filteredItems.length === 0) {
                     itemsList.innerHTML = '<div class="loading"><div class="loading-icon">üìù</div><div>No items found. Add your first grocery item!</div></div>';
                     return;
                 }

                 itemsList.innerHTML = filteredItems.map(item => `
                     <div class="product-card">
                         <div class="product-header">
                             <div>
                                 <div class="product-title">${item.name}</div>
                                 <div class="product-category">${item.category}</div>
                             </div>
                         </div>
                         <div class="product-details">
                             <div class="product-detail">
                                 <span class="detail-label">Quantity:</span>
                                 <span class="detail-value">${item.quantity} ${item.unit}</span>
                             </div>
                             <div class="product-detail">
                                 <span class="detail-label">Consumption Rate:</span>
                                 <span class="detail-value">${item.consumption_rate} per day</span>
                             </div>
                             <div class="product-detail>
                                 <span class="detail-label">Household Size:</span>
                                 <span class="detail-value">${item.household_size}</span>
                             </div>
                             <div class="product-detail">
                                 <span class="detail-label">Last Purchased:</span>
                                 <span class="detail-value">${item.last_purchased ? new Date(item.last_purchased).toLocaleDateString() : 'Never'}</span>
                             </div>
                         </div>
                                                  <div style="margin-top: 20px; display: flex; gap: 10px;">
                               <button onclick="editItem(${item.id})" class="btn btn-secondary">‚úèÔ∏è Edit</button>
                               <button onclick="deleteItem(${item.id})" class="btn btn-danger">üóëÔ∏è Delete</button>
                           </div>
                     </div>
                 `).join('');

                 // Stop AI training animation after data is loaded
                 setTimeout(() => {
                     stopAITrainingAnimation();
                 }, 1000);

             } catch (error) {
                 console.error('Error loading items:', error);
                 showAlert('Error loading items', 'error');
                 stopAITrainingAnimation();
             }
         }

                   // Load order history
          async function loadOrderHistory() {
              // Show loading state
              showLoadingState('order-history');
              startAITrainingAnimation();
              
              try {
                  const response = await fetch(`${API_BASE}/order-history/${currentUserId}`);
                  const orders = await response.json();

                  // Filter by category if selected
                  let filteredOrders = orders;
                  if (currentCategory !== 'all') {
                      filteredOrders = orders.filter(order => order.category === currentCategory);
                  }

                  const orderHistoryList = document.getElementById('order-history-list');
                  if (filteredOrders.length === 0) {
                      orderHistoryList.innerHTML = '<div class="loading"><div class="loading-icon">üìã</div><div>No order history found. Place your first order!</div></div>';
                      return;
                  }

                  // Group orders by order number if they exist, otherwise show individual orders
                  const orderGroups = {};
                  filteredOrders.forEach(order => {
                      const orderKey = order.order_number || `individual_${order.id}`;
                      if (!orderGroups[orderKey]) {
                          orderGroups[orderKey] = {
                              order_number: order.order_number || `ORD-${order.id}`,
                              order_date: order.order_date,
                              delivery_date: order.delivery_date,
                              status: order.status || 'delivered',
                              items: []
                          };
                      }
                      orderGroups[orderKey].items.push(order);
                  });

                  orderHistoryList.innerHTML = Object.values(orderGroups).map(orderGroup => `
                      <div class="product-card">
                          <div class="product-header">
                              <div>
                                  <div class="product-title">üì¶ Order ${orderGroup.order_number}</div>
                                  <div class="product-category">${orderGroup.items.length} item${orderGroup.items.length > 1 ? 's' : ''}</div>
                              </div>
                              <div style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;">
                                  ${orderGroup.status.toUpperCase()}
                                  ${currentOrder && currentOrder.order_number === orderGroup.order_number ? ' ‚è∞ ACTIVE' : ''}
                              </div>
                          </div>
                          <div class="product-details">
                              <div class="product-detail">
                                  <span class="detail-label">Items Ordered:</span>
                                  <span class="detail-value">${orderGroup.items.map(item => `${item.quantity} ${item.unit} ${item.item_name}`).join(', ')}</span>
                              </div>
                              <div class="product-detail">
                                  <span class="detail-label">Order Date:</span>
                                  <span class="detail-value">${new Date(orderGroup.order_date).toLocaleDateString()}</span>
                              </div>
                              <div class="product-detail">
                                  <span class="detail-label">Delivery Date:</span>
                                  <span class="detail-value">${new Date(orderGroup.delivery_date).toLocaleDateString()}</span>
                              </div>
                              <div class="product-detail">
                                  <span class="detail-label">Total Items:</span>
                                  <span class="detail-value">${orderGroup.items.length}</span>
                              </div>
                          </div>
                          <div style="margin-top: 20px; display: flex; gap: 10px;">
                              ${currentOrder && currentOrder.order_number === orderGroup.order_number ? 
                                  `<button onclick="deleteOrderGroup('${orderGroup.order_number}', ${orderGroup.items.length})" class="btn btn-danger">‚ùå Cancel Active Order</button>` :
                                  `<button onclick="deleteOrderGroup('${orderGroup.order_number}', ${orderGroup.items.length})" class="btn btn-danger">üóëÔ∏è Delete Order</button>`
                              }
                              <button onclick="reorderGroup('${orderGroup.order_number}')" class="btn btn-success">üîÑ Reorder All</button>
                          </div>
                      </div>
                  `).join('');

                  // Stop AI training animation after data is loaded
                  setTimeout(() => {
                      stopAITrainingAnimation();
                  }, 1000);

              } catch (error) {
                  console.error('Error loading order history:', error);
                  stopAITrainingAnimation();
                  // If order history endpoint doesn't exist, show a message
                  document.getElementById('order-history-list').innerHTML = `
                      <div class="loading">
                          <div class="loading-icon">üìã</div>
                          <div>Order history feature coming soon! Your orders are being tracked.</div>
                      </div>
                  `;
              }
          }

          // Show AI Learning Status
          async function showAILearningStatus() {
              const button = event.target;
              const originalText = button.textContent;
              const statusDiv = document.getElementById('ai-learning-status');
              const messageDiv = document.getElementById('ai-learning-message');
              
              try {
                  // Show loading state
                  button.textContent = 'üìä Analyzing...';
                  button.disabled = true;
                  statusDiv.style.display = 'block';
                  messageDiv.innerHTML = '<div style="color: #666;">üìä Analyzing current AI learning status and improvements...</div>';
                  
                  const response = await fetch(`${API_BASE}/order-history/${currentUserId}/deletion-impact`);
                  
                  if (response.ok) {
                      const result = await response.json();
                      
                      // Show AI learning status
                      messageDiv.innerHTML = `
                          <div style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                              üß† AI Learning Status & Improvements
                          </div>
                          <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                      <strong>Total Items:</strong> ${result.total_items}
                                  </div>
                                  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                      <strong>Improved Rates:</strong> ${result.items_with_improved_rates}
                                  </div>
                                  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                      <strong>AI Status:</strong> <span style="color: ${result.ai_model_status === 'trained' ? '#28a745' : '#ffc107'}">${result.ai_model_status}</span>
                                  </div>
                                  <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                      <strong>Household Size:</strong> ${result.household_size_detected}
                                  </div>
                              </div>
                          </div>
                          ${result.consumption_rate_changes.length > 0 ? `
                              <div style="margin-bottom: 15px;">
                                  <strong style="color: #333;">Consumption Rate Improvements:</strong>
                                  <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                                      ${result.consumption_rate_changes.map(item => `
                                          <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 0.85rem;">
                                              <strong>${item.item_name}</strong> (${item.category}): 
                                              ${item.improvement > 0 ? `+${item.improvement}%` : `${item.improvement}%`} improvement
                                          </div>
                                      `).join('')}
                                  </div>
                              </div>
                          ` : ''}
                          ${result.recommendations.length > 0 ? `
                              <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107;">
                                  <strong style="color: #856404;">üí° Recommendations:</strong>
                                  <ul style="margin: 10px 0 0 20px; color: #856404;">
                                      ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                  </ul>
                              </div>
                          ` : ''}
                          <div style="background: #e8f5e8; padding: 10px; border-radius: 6px; border-left: 4px solid #28a745; margin-top: 15px;">
                              <strong style="color: #155724;">üöÄ Automatic Learning Active</strong>
                              <div style="color: #155724; font-size: 0.85rem; margin-top: 5px;">
                                  The AI automatically trains after every action (orders, deletions, updates). 
                                  No manual intervention needed!
                              </div>
                          </div>
                      `;
                      
                  } else {
                      throw new Error('Failed to get AI learning status');
                  }
                  
              } catch (error) {
                  console.error('Error getting AI learning status:', error);
                  messageDiv.innerHTML = `
                      <div style="color: #dc3545; font-weight: 600;">
                          ‚ùå Error analyzing AI learning status
                     </div>
                     <div style="font-size: 0.9rem; color: #666;">
                         Please try again later or contact support.
                     </div>
                 `;
              } finally {
                  // Reset button
                  button.textContent = originalText;
                  button.disabled = false;
              }
          }

        // Refresh predictions
        function refreshPredictions() {
            loadPredictions();
        }

        // Place order
        async function placeOrder(itemId, quantity) {
            try {
                const response = await fetch(`${API_BASE}/order/${itemId}?quantity=${quantity}&user_id=${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showAlert('Order placed successfully! üéâ', 'success');
                    loadPredictions();
                    loadDashboard();
                } else {
                    showAlert('Error placing order', 'error');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                showAlert('Error placing order', 'error');
            }
        }

        // Quick Order function (same as placeOrder but with different messaging)
        async function quickOrder(itemId, quantity) {
            // Show AI training indicator
            updateAIStatus('learning');
            showAlert('‚ö° Processing Quick Order...\n\nü§ñ AI is learning from your preferences...', 'success');
            
            try {
                const response = await fetch(`${API_BASE}/order/${itemId}?quantity=${quantity}&user_id=${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show AI learning feedback
                    let aiMessage = '';
                    if (result.ai_learning?.learned) {
                        aiMessage = `üß† AI Learning Complete!\n‚Ä¢ Updated consumption patterns\n‚Ä¢ Improved future predictions\n‚Ä¢ Household size: ${result.ai_learning.new_rate ? 'Adapted' : 'Analyzing'}`;
                    } else {
                        aiMessage = 'üß† AI Learning: Analyzing your preferences...';
                    }
                    
                    showAlert(`‚ö° Quick Order placed successfully! üéâ\n\n${aiMessage}`, 'success');
                    updateAIStatus('training');
                    
                    // Refresh all data with loading states
                    loadPredictions();
                    loadDashboard();
                    loadOrderHistory();
                } else {
                    showAlert('Error placing quick order', 'error');
                }
            } catch (error) {
                console.error('Error placing quick order:', error);
                showAlert('Error placing quick order', 'error');
            }
        }

        // Delete item
        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/items/${itemId}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Item deleted successfully! üóëÔ∏è', 'success');
                    loadItems();
                    loadDashboard();
                } else {
                    showAlert('Error deleting item', 'error');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showAlert('Error deleting item', 'error');
            }
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.quick-features'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

                 // Handle form submission
         document.getElementById('add-item-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             const formData = {
                 name: document.getElementById('item-name').value,
                 brand: document.getElementById('item-brand').value || "Local",
                 category: currentCategory === 'all' ? 'All' : currentCategory, // Use current category from filter
                 quantity: parseFloat(document.getElementById('item-quantity').value),
                 unit: document.getElementById('quantity-unit').textContent,
                 image_url: "https://example.com/default.jpg", // Default image
                 household_size: getHouseholdSize(currentUser) // AI will detect and update this
             };

            try {
                const response = await fetch(`${API_BASE}/items/?user_id=${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('Item added to AI Grocery List! ü§ñ AI will now track your consumption patterns.', 'success');
                    resetAddItemForm();
                    loadDashboard();
                } else {
                    showAlert('Error adding item to AI Grocery List', 'error');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showAlert('Error adding item to AI Grocery List', 'error');
            }
        });

        // Search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            // Implement search logic here
            console.log('Searching for:', searchTerm);
        });

                 // Load initial data
         // This DOMContentLoaded is removed - using the main one below

        // Custom persona form submission
        document.getElementById('custom-persona-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createCustomPersona();
        });

                 // Category-based Item Selection
         const CATEGORY_ITEMS = {
             "All": [
                 // Dairy
                 { name: "Milk", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0, category: "Dairy" },
                 { name: "Curd", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5, category: "Dairy" },
                 { name: "Paneer", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25, category: "Dairy" },
                 { name: "Butter", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1, category: "Dairy" },
                 { name: "Cheese", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1, category: "Dairy" },
                 { name: "Ice Cream", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0, category: "Dairy" },
                 // Produce
                 { name: "Apple", image: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0, category: "Produce" },
                 { name: "Banana", image: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0, category: "Produce" },
                 { name: "Tomato", image: "https://images.unsplash.com/photo-1546094096-0df4bcaaa337?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5, category: "Produce" },
                 { name: "Onion", image: "https://images.unsplash.com/photo-1518977676601-b53f82aba655?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0, category: "Produce" },
                 { name: "Potato", image: "https://images.unsplash.com/photo-1518977676601-b53f82aba655?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 2.0, category: "Produce" },
                 { name: "Carrot", image: "https://images.unsplash.com/photo-1447175008436-170170e88629?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5, category: "Produce" },
                 // Bakery
                 { name: "Bread", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2, category: "Bakery" },
                 { name: "Biscuits", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2, category: "Bakery" },
                 { name: "Cakes", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "pieces", defaultQuantity: 1, category: "Bakery" },
                 { name: "Cookies", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1, category: "Bakery" },
                 // Pantry
                 { name: "Rice", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 5.0, category: "Pantry" },
                 { name: "Dal", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0, category: "Pantry" },
                 { name: "Oil", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0, category: "Pantry" },
                 { name: "Sugar", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0, category: "Pantry" },
                 { name: "Salt", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5, category: "Pantry" },
                 // Snacks
                 { name: "Chips", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2, category: "Snacks" },
                 { name: "Nuts", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25, category: "Snacks" },
                 { name: "Chocolates", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2, category: "Snacks" }
             ],
                           "Dairy": [
                  { name: "Milk", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0 },
                  { name: "Curd", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5 },
                  { name: "Paneer", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25 },
                  { name: "Butter", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1 },
                  { name: "Cheese", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1 },
                  { name: "Ice Cream", image: "https://images.unsplash.com/photo-1550583724-b2692b85b150?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0 }
              ],
              "Produce": [
                { name: "Apple", image: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Banana", image: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Tomato", image: "https://images.unsplash.com/photo-1546094096-0df4bcaaa337?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5 },
                { name: "Onion", image: "https://images.unsplash.com/photo-1518977676601-b53f82aba655?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Potato", image: "https://images.unsplash.com/photo-1518977676601-b53f82aba655?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 2.0 },
                { name: "Carrot", image: "https://images.unsplash.com/photo-1447175008436-170170e88629?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5 }
            ],
            "Bakery": [
                { name: "Bread", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2 },
                { name: "Biscuits", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2 },
                { name: "Cakes", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "pieces", defaultQuantity: 1 },
                { name: "Cookies", image: "https://images.unsplash.com/photo-1509446633198-9f19d968c321?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1 }
            ],
            "Pantry": [
                { name: "Rice", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 5.0 },
                { name: "Dal", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Oil", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0 },
                { name: "Sugar", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Salt", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5 }
            ],
            "Frozen": [
                { name: "Frozen Peas", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.5 },
                { name: "Ice Cream", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0 },
                { name: "Frozen Pizza", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "pieces", defaultQuantity: 1 }
            ],
            "Beverages": [
                { name: "Tea", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25 },
                { name: "Coffee", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25 },
                { name: "Juice", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "liters", defaultQuantity: 1.0 }
            ],
            "Snacks": [
                { name: "Chips", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2 },
                { name: "Nuts", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 0.25 },
                { name: "Chocolates", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 2 }
            ],
            "Household": [
                { name: "Soap", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "pieces", defaultQuantity: 2 },
                { name: "Detergent", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "kg", defaultQuantity: 1.0 },
                { name: "Tissue", image: "https://images.unsplash.com/photo-1586201375761-83865001e31c?w=150&h=150&fit=crop", unit: "packets", defaultQuantity: 1 }
            ]
        };

                 function loadCategoryItems() {
             const category = currentCategory === 'all' ? 'All' : currentCategory;
             const categoryItems = document.getElementById('category-items');
             
             if (!category) {
                 categoryItems.innerHTML = '<div class="loading"><div class="loading-icon">üè∑Ô∏è</div><div>Select a category from "Shop by Category" above</div></div>';
                 return;
             }
             
             const items = CATEGORY_ITEMS[category] || [];
             if (items.length === 0) {
                 categoryItems.innerHTML = '<div class="loading"><div class="loading-icon">‚ùå</div><div>No items found for this category</div></div>';
                 return;
             }
             
             categoryItems.innerHTML = items.map(item => `
                 <div class="item-box" onclick="selectItem('${item.name}', '${item.unit}', ${item.defaultQuantity}, '${item.category || category}')">
                     <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/80x80/f0f0f0/666?text=${item.name.charAt(0)}'">
                     <div class="item-name">${item.name}</div>
                     <div class="category-badge">${item.category || category}</div>
                     <div class="item-unit">${item.unit}</div>
                 </div>
             `).join('');
         }

                                   function selectItem(itemName, unit, defaultQuantity, category = null) {
              // Remove previous selection
              document.querySelectorAll('.item-box').forEach(box => box.classList.remove('selected'));
              
              // Add selection to clicked box
              event.target.closest('.item-box').classList.add('selected');
              
              // Clear the form first to remove any previous item details
              document.getElementById('add-item-form').reset();
              
              // Populate form with new item details
              document.getElementById('item-name').value = itemName;
              document.getElementById('quantity-unit').textContent = unit;
              document.getElementById('item-quantity').value = defaultQuantity;
              document.getElementById('item-quantity').step = unit === 'kg' || unit === 'liters' ? '0.1' : '1';
              document.getElementById('item-quantity').min = unit === 'kg' || unit === 'liters' ? '0.1' : '1';
              
              // Clear brand field as it's specific to each item
              document.getElementById('item-brand').value = '';
              
              // Show form
              document.getElementById('add-item-form-container').style.display = 'block';
              
              // Scroll to form
              document.getElementById('add-item-form-container').scrollIntoView({ behavior: 'smooth' });
          }

                                   function resetAddItemForm() {
              // Hide the form container
              document.getElementById('add-item-form-container').style.display = 'none';
              
              // Reset the form completely
              document.getElementById('add-item-form').reset();
              
              // Clear any custom values that might not be reset by form.reset()
              document.getElementById('item-name').value = '';
              document.getElementById('item-brand').value = '';
              document.getElementById('item-quantity').value = '';
              document.getElementById('quantity-unit').textContent = 'kg';
              
              // Remove all item selections
              document.querySelectorAll('.item-box').forEach(box => box.classList.remove('selected'));
          }

         // Add selected item to cart from Add Item tab
         function addSelectedItemToCart() {
             const itemName = document.getElementById('item-name').value;
             const itemQuantity = parseFloat(document.getElementById('item-quantity').value);
             const itemUnit = document.getElementById('quantity-unit').textContent;
             const itemCategory = currentCategory === 'all' ? 'All' : currentCategory;
             
             if (!itemName || !itemQuantity) {
                 showAlert('Please select an item and specify quantity first!', 'error');
                 return;
             }
             
             // Create a cart item object with special flag for new items
             const cartItem = {
                 item_id: `new_${Date.now()}`, // Special ID for new items
                 item_name: itemName,
                 category: itemCategory,
                 quantity: itemQuantity,
                 unit: itemUnit,
                 suggested_quantity: itemQuantity,
                 is_new_item: true, // Flag to identify new items
                 brand: document.getElementById('item-brand').value || "Local"
             };
             
             addToCart(cartItem);
             showAlert(`Added ${itemName} to cart! üõí`, 'success');
         }

        // Shopping Cart Functions
        function toggleCart() {
            const cartModal = document.getElementById('shopping-cart-modal');
            const isOpening = cartModal.style.display !== 'flex';
            
            cartModal.style.display = isOpening ? 'flex' : 'none';
            
            if (isOpening) {
                // Prevent background scrolling when modal is open
                document.body.style.overflow = 'hidden';
                updateCartDisplay();
            } else {
                // Restore background scrolling when modal is closed
                document.body.style.overflow = 'auto';
            }
        }

        function closeCart() {
            document.getElementById('shopping-cart-modal').style.display = 'none';
            // Restore background scrolling when modal is closed
            document.body.style.overflow = 'auto';
        }

        function addToCart(item) {
            console.log('Adding item to cart:', item);
            console.log('Item ID type:', typeof item.item_id, 'Value:', item.item_id);
            
            const existingItem = shoppingCart.find(cartItem => cartItem.item_id === item.item_id);
            
            if (existingItem) {
                existingItem.quantity += item.suggested_quantity;
                console.log('Updated existing item quantity to:', existingItem.quantity);
            } else {
                const cartItem = {
                    ...item,
                    quantity: item.suggested_quantity
                };
                shoppingCart.push(cartItem);
                console.log('Added new item to cart:', cartItem);
            }
            
            updateCartCount();
            updateCartDisplay(); // Ensure cart display is updated
            showAlert(`Added ${item.item_name} to cart! üõí`, 'success');
        }

        function removeFromCart(itemId) {
            console.log('Attempting to remove item:', itemId, 'Type:', typeof itemId);
            console.log('Current cart before removal:', shoppingCart.length, 'items');
            
            // Convert itemId to number for comparison
            const numericItemId = parseInt(itemId);
            
            // Find the item index - try both string and number comparison
            const itemIndex = shoppingCart.findIndex(item => 
                item.item_id === numericItemId || item.item_id === itemId
            );
            
            if (itemIndex !== -1) {
                // Remove the item
                const removedItem = shoppingCart.splice(itemIndex, 1)[0];
                console.log('Removed item:', removedItem.item_name);
                
                // Update the display
                updateCartCount();
                updateCartDisplay();
                showAlert(`${removedItem.item_name} removed from cart! üóëÔ∏è`, 'success');
            } else {
                console.error('Item not found in cart. Item ID:', itemId, 'Type:', typeof itemId);
                console.error('Available items:', shoppingCart.map(item => ({ 
                    id: item.item_id, 
                    name: item.item_name, 
                    type: typeof item.item_id 
                })));
                showAlert('Item not found in cart', 'error');
            }
        }

        function clearCart() {
            if (confirm('Are you sure you want to clear your cart?')) {
                shoppingCart = [];
                updateCartCount();
                updateCartDisplay();
                showAlert('Cart cleared! üóëÔ∏è', 'success');
            }
        }

        // Test function for debugging cart functionality
        function testCartFunctionality() {
            console.log('=== CART FUNCTIONALITY TEST ===');
            console.log('Current cart:', shoppingCart);
            console.log('Cart length:', shoppingCart.length);
            
            if (shoppingCart.length > 0) {
                console.log('Testing remove functionality...');
                const firstItem = shoppingCart[0];
                console.log('First item:', firstItem);
                console.log('Item ID:', firstItem.item_id, 'Type:', typeof firstItem.item_id);
                
                // Test the remove function
                removeFromCart(firstItem.item_id);
            } else {
                console.log('Cart is empty. Add some items first to test removal.');
            }
        }

        function updateCartCount() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('cart-count-quick').textContent = totalItems;
        }

        async function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartSummary = document.getElementById('cart-summary');
            
            if (shoppingCart.length === 0) {
                cartItems.innerHTML = '<div class="loading"><div class="loading-icon">üõí</div><div>Your cart is empty</div></div>';
                cartSummary.style.display = 'none';
                return;
            }
            
            cartItems.innerHTML = shoppingCart.map((item, index) => `
                 <div class="cart-item" data-item-index="${index}">
                     <div class="cart-item-info">
                         <div class="cart-item-name">${item.item_name}</div>
                         <div class="cart-item-details">
                             ${item.category} ‚Ä¢ ${item.quantity.toFixed(1)} ${item.unit}
                             ${item.is_new_item ? '<span class="item-badge new">NEW</span>' : ''}
                             ${item.is_reorder ? '<span class="item-badge reorder">REORDER</span>' : ''}
                         </div>
                     </div>
                     <button class="btn btn-danger cart-remove-btn" data-item-id="${item.item_id}">üóëÔ∏è</button>
                 </div>
             `).join('');
             
            // Add event listeners to all remove buttons
            cartItems.querySelectorAll('.cart-remove-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const itemId = this.getAttribute('data-item-id');
                    removeFromCart(itemId);
                });
            });
            
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-total-items').textContent = totalItems.toFixed(1);
            cartSummary.style.display = 'block';
            
            // Load and display delivery tier information
            await loadDeliveryTierInfo();
            
            // Load AI-powered suggestions
            await loadDontForgetSuggestions();
            
            
            // Add scroll event listener to cart items (only once)
            const cartItemsElement = document.getElementById('cart-items');
            if (!cartItemsElement.hasAttribute('data-scroll-listener')) {
                cartItemsElement.setAttribute('data-scroll-listener', 'true');
                cartItemsElement.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }
        }


        async function loadDeliveryTierInfo() {
            try {
                const subtotal = shoppingCart.reduce((sum, item) => sum + (item.quantity * (item.unit_price || 0)), 0);
                const response = await fetch(`${API_BASE}/delivery-tiers?current_subtotal=${subtotal}`);
                const tiers = await response.json();
                
                // Find current tier - New logic: Free delivery for orders >= ‚Çπ100
                const currentTier = subtotal >= 100 ? 
                    tiers.find(tier => tier.tier_name === 'free') || tiers[0] : 
                    tiers.find(tier => tier.tier_name === 'standard') || tiers[1];
                
                // Update cart summary with delivery info
                const cartSummary = document.getElementById('cart-summary');
                if (cartSummary) {
                    const existingDeliveryInfo = cartSummary.querySelector('.delivery-info');
                    if (existingDeliveryInfo) {
                        existingDeliveryInfo.remove();
                    }
                    
                    const deliveryInfo = document.createElement('div');
                    deliveryInfo.className = 'delivery-info';
                    deliveryInfo.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #007bff;">
                            <h4 style="margin: 0 0 15px 0; color: #333;">üöö Delivery Information</h4>
                            
                            <!-- Delivery Address Input -->
                            <div style="margin-bottom: 15px;">
                                <label for="delivery-address" style="display: block; font-weight: 600; color: #333; margin-bottom: 5px;">Delivery Address:</label>
                                <input type="text" id="delivery-address" placeholder="Enter your delivery address" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.9rem;"
                                       value="123 Main St, Delhi">
                                <button onclick="calculateDeliveryTime()" class="btn" style="margin-top: 8px; padding: 8px 16px; font-size: 0.9rem;">
                                    üïê Calculate Delivery Time
                                </button>
                            </div>
                            
                            <!-- Dynamic Delivery Info -->
                            <div id="dynamic-delivery-info" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Store:</span>
                                    <span style="font-weight: 600; color: #007bff;" id="store-name">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Delivery Zone:</span>
                                    <span style="font-weight: 600; color: #007bff;" id="delivery-zone">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Traffic Condition:</span>
                                    <span style="font-weight: 600; color: #333;" id="traffic-condition">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Estimated Delivery:</span>
                                    <span style="font-weight: 600; color: #333;" id="estimated-delivery-time">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Grace Period:</span>
                                    <span style="font-weight: 600; color: #28a745;" id="grace-period-time">-</span>
                                </div>
                            </div>
                            
                            <!-- Static Delivery Info -->
                            <div id="static-delivery-info">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Delivery Tier:</span>
                                    <span style="font-weight: 600; color: #007bff;">${currentTier.tier_name.toUpperCase()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Delivery Fee:</span>
                                    <span style="font-weight: 600; color: ${currentTier.delivery_fee === 0 ? '#28a745' : '#333'};">‚Çπ${currentTier.delivery_fee}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: bold; color: #333; padding-top: 10px; border-top: 1px solid #dee2e6;">
                                    <span>Total:</span>
                                    <span>‚Çπ${(subtotal + currentTier.delivery_fee).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            ${subtotal < 100 ? `
                                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ffc107;">
                                    <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">üí° Save on Delivery!</div>
                                    <div style="font-size: 0.9rem; color: #856404;">Add ‚Çπ${(100 - subtotal).toFixed(0)} more for FREE delivery!</div>
                                    <div style="font-size: 0.8rem; color: #856404; margin-top: 3px;">Current: ‚Çπ${subtotal.toFixed(2)} | Need: ‚Çπ100+ for free delivery</div>
                                </div>
                            ` : `
                                <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #28a745;">
                                    <div style="font-weight: 600; color: #155724; margin-bottom: 5px;">üéâ You qualify for FREE delivery!</div>
                                    <div style="font-size: 0.9rem; color: #155724;">Order value: ‚Çπ${subtotal.toFixed(2)} (‚â• ‚Çπ100)</div>
                                </div>
                            `}
                        </div>
                    `;
                    
                    cartSummary.appendChild(deliveryInfo);
                }
            } catch (error) {
                console.error('Error loading delivery tier info:', error);
            }
        }

        async function calculateDeliveryTime() {
            const address = document.getElementById('delivery-address').value;
            if (!address.trim()) {
                showAlert('Please enter a delivery address', 'error');
                return;
            }
            
            try {
                // Extract pincode from address (simplified - in real implementation, use geocoding)
                const pincode = extractPincodeFromAddress(address);
                
                const deliveryRequest = {
                    delivery_address: address,
                    pincode: pincode,
                    city: "Delhi", // In real implementation, extract from address
                    state: "Delhi"  // In real implementation, extract from address
                };
                
                const response = await fetch(`${API_BASE}/calculate-delivery-time`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deliveryRequest)
                });
                
                if (response.ok) {
                    const calculation = await response.json();
                    displayDeliveryCalculation(calculation);
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error calculating delivery time', 'error');
                }
            } catch (error) {
                console.error('Error calculating delivery time:', error);
                showAlert('Error calculating delivery time', 'error');
            }
        }

        function extractPincodeFromAddress(address) {
            // Simple pincode extraction - in real implementation, use proper geocoding
            const pincodeMatch = address.match(/\b(\d{6})\b/);
            return pincodeMatch ? pincodeMatch[1] : "110001";
        }

        function displayDeliveryCalculation(calculation) {
            // Show dynamic delivery info
            document.getElementById('dynamic-delivery-info').style.display = 'block';
            document.getElementById('static-delivery-info').style.display = 'none';
            
            // Update the display
            document.getElementById('store-name').textContent = calculation.store_name;
            document.getElementById('delivery-zone').textContent = calculation.delivery_zone;
            document.getElementById('traffic-condition').textContent = calculation.traffic_condition;
            document.getElementById('estimated-delivery-time').textContent = `${calculation.estimated_delivery_time_minutes} minutes`;
            document.getElementById('grace-period-time').textContent = `${calculation.grace_period_minutes} minutes (30% of delivery time)`;
            
            // Store calculation for order placement
            window.currentDeliveryCalculation = calculation;
            
            showAlert(`Delivery calculated! Grace period: ${calculation.grace_period_minutes} minutes`, 'success');
        }

        async function loadDontForgetSuggestions() {
            try {
                if (shoppingCart.length === 0) return;
                
                const response = await fetch(`${API_BASE}/analyze-cart/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shoppingCart)
                });
                
                if (response.ok) {
                    const analysis = await response.json();
                    displayDontForgetSuggestions(analysis.suggestions);
                }
            } catch (error) {
                console.error('Error loading AI suggestions:', error);
            }
        }

        function displayDontForgetSuggestions(suggestions) {
            const cartSummary = document.getElementById('cart-summary');
            if (!cartSummary || suggestions.length === 0) return;
            
            // Remove existing suggestions
            const existingSuggestions = cartSummary.querySelector('.dont-forget-suggestions');
            if (existingSuggestions) {
                existingSuggestions.remove();
            }
            
            const suggestionsHtml = `
                <div class="dont-forget-suggestions" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 15px 0; color: #856404; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">üß†</span>
                        Don't Forget These Items!
                    </h4>
                    <div style="display: grid; gap: 10px;">
                        ${suggestions.map(suggestion => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ffeaa7;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                        ${suggestion.item_name}
                                        <span style="background: ${getPriorityColor(suggestion.priority)}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">
                                            ${suggestion.priority.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">
                                        ${suggestion.category} ‚Ä¢ ${suggestion.reason}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #856404;">
                                        Confidence: ${Math.round(suggestion.confidence * 100)}%
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="addSuggestedItem('${suggestion.item_name}', '${suggestion.category}')" 
                                            class="btn" 
                                            style="padding: 6px 12px; font-size: 0.8rem; background: #28a745;">
                                        ‚ûï Add
                                    </button>
                                    <button onclick="dismissSuggestion('${suggestion.item_name}')" 
                                            class="btn btn-secondary" 
                                            style="padding: 6px 12px; font-size: 0.8rem;">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button onclick="refreshSuggestions()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                            üîÑ Refresh Suggestions
                        </button>
                    </div>
                </div>
            `;
            
            cartSummary.insertAdjacentHTML('beforeend', suggestionsHtml);
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'high': return '#dc3545';
                case 'medium': return '#ffc107';
                case 'low': return '#6c757d';
                default: return '#6c757d';
            }
        }

        function addSuggestedItem(itemName, category) {
            // Add the suggested item to cart
            const suggestedItem = {
                item_id: `suggested_${Date.now()}`,
                item_name: itemName,
                category: category,
                quantity: 1,
                unit: 'pieces',
                unit_price: 0, // This would be fetched from a price database
                is_suggested: true
            };
            
            addToCart(suggestedItem);
            showAlert(`Added ${itemName} to your cart! üõí`, 'success');
            
            // Refresh the cart display to update suggestions
            updateCartDisplay();
        }

        function dismissSuggestion(itemName) {
            // Remove the suggestion from display
            const suggestions = document.querySelector('.dont-forget-suggestions');
            if (suggestions) {
                // Find and remove the specific suggestion
                const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
                suggestionItems.forEach(item => {
                    if (item.textContent.includes(itemName)) {
                        item.remove();
                    }
                });
                
                // If no suggestions left, hide the entire section
                if (suggestions.querySelectorAll('.suggestion-item').length === 0) {
                    suggestions.remove();
                }
            }
        }

        async function refreshSuggestions() {
            await loadDontForgetSuggestions();
        }

                 async function placeCartOrder() {
             if (shoppingCart.length === 0) {
                 showAlert('Your cart is empty!', 'error');
                 return;
             }
             
             try {
                 let successCount = 0;
                 let orderNumber = 'ORD-' + Date.now(); // Generate order number
                 
                 // Create a mock order for status display
                 const mockOrder = {
                     order_number: orderNumber,
                     grace_period_ends: new Date(Date.now() + 5 * 60 * 1000), // 5 minutes grace period
                     estimated_delivery_time: new Date(Date.now() + 25 * 60 * 1000), // 25 minutes delivery time
                     id: Date.now(),
                     status: 'placed',
                     created_at: new Date()
                 };
                 
                 // Show order status bar immediately
                 currentOrder = mockOrder;
                 showOrderStatusBar(mockOrder, 'grace-period');
                 startGracePeriodCountdown(mockOrder);
                 
                 // Track ordered items during grace period
                 shoppingCart.forEach(item => {
                     addToOrderedItems(item.item_id);
                 });
                 
                 for (const cartItem of shoppingCart) {
                     try {
                         if (cartItem.is_new_item) {
                             // For new items, create them in inventory first
                             const createResponse = await fetch(`${API_BASE}/items/?user_id=${currentUserId}`, {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json'
                                 },
                                 body: JSON.stringify({
                                     name: cartItem.item_name,
                                     brand: cartItem.brand,
                                     category: cartItem.category,
                                     quantity: cartItem.quantity,
                                     unit: cartItem.unit,
                                     image_url: "https://example.com/default.jpg",
                                     household_size: getHouseholdSize(currentUser)
                                 })
                             });
                             
                             if (createResponse.ok) {
                                 const newItem = await createResponse.json();
                                 // Now place order for the newly created item
                                 const orderResponse = await fetch(`${API_BASE}/order/${newItem.id}?quantity=${cartItem.quantity}&user_id=${currentUserId}`, {
                                     method: 'POST'
                                 });
                                 
                                 if (orderResponse.ok) {
                                     successCount++;
                                 } else {
                                     console.error('Order failed for new item:', cartItem.item_name);
                                 }
                             } else {
                                 console.error('Failed to create new item:', cartItem.item_name);
                             }
                         } else {
                             // For existing items, place order directly
                             const response = await fetch(`${API_BASE}/order/${cartItem.item_id}?quantity=${cartItem.quantity}&user_id=${currentUserId}`, {
                                 method: 'POST'
                             });
                             
                             if (response.ok) {
                                 successCount++;
                             } else {
                                 console.error('Order failed for existing item:', cartItem.item_name);
                             }
                         }
                     } catch (itemError) {
                         console.error(`Error processing item ${cartItem.item_name}:`, itemError);
                     }
                 }
                 
                 if (successCount === shoppingCart.length) {
                     showAlert(`Order #${orderNumber} placed successfully! üéâ`, 'success');
                     
                     // Show AI learning notification if any items were learned from
                     let learningMessage = '';
                     if (successCount > 0) {
                         learningMessage = '\n\nüß† The AI is learning from your orders to improve future predictions!';
                     }
                     
                     shoppingCart = [];
                     updateCartCount();
                     closeCart();
                     loadDashboard();
                     loadPredictions();
                     loadOrderHistory(); // Refresh order history
                     
                     // Show AI learning message after a delay
                     if (learningMessage) {
                         setTimeout(() => {
                             showAlert(`AI Learning Complete!${learningMessage}`, 'success');
                         }, 1500);
                     }
                 } else {
                     showAlert(`Ordered ${successCount} out of ${shoppingCart.length} items`, 'error');
                 }
             } catch (error) {
                 console.error('Error placing cart order:', error);
                 showAlert('Error placing order', 'error');
             }
         }

        // New cart order function with proper order ID and item list
        async function placeCartOrderNew() {
            if (shoppingCart.length === 0) {
                showAlert('Your cart is empty!', 'error');
                return;
            }
            
            try {
                // Prepare cart items for the new order endpoint
                const cartItems = [];
                
                for (const cartItem of shoppingCart) {
                    if (cartItem.is_new_item) {
                        // For new items, create them in inventory first
                        const createResponse = await fetch(`${API_BASE}/items/?user_id=${currentUserId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: cartItem.item_name,
                                brand: cartItem.brand,
                                category: cartItem.category,
                                quantity: cartItem.quantity,
                                unit: cartItem.unit,
                                image_url: "https://example.com/default.jpg",
                                household_size: getHouseholdSize(currentUser)
                            })
                        });
                        
                        if (createResponse.ok) {
                            const newItem = await createResponse.json();
                            cartItems.push({
                                item_id: newItem.id,
                                item_name: cartItem.item_name,
                                category: cartItem.category,
                                quantity: cartItem.quantity,
                                unit: cartItem.unit,
                                brand: cartItem.brand,
                                unit_price: 50, // Default price - you can make this dynamic
                                total_price: cartItem.quantity * 50
                            });
                        } else {
                            console.error('Failed to create new item:', cartItem.item_name);
                        }
                    } else {
                        // For existing items, add to cart items
                        cartItems.push({
                            item_id: cartItem.item_id,
                            item_name: cartItem.item_name,
                            category: cartItem.category,
                            quantity: cartItem.quantity,
                            unit: cartItem.unit,
                            brand: cartItem.brand,
                            unit_price: 50, // Default price - you can make this dynamic
                            total_price: cartItem.quantity * 50
                        });
                    }
                }
                
                if (cartItems.length === 0) {
                    showAlert('No valid items to order. Please try again.', 'error');
                    return;
                }
                
                // Create the order using the new cart endpoint
                const orderResponse = await fetch(`${API_BASE}/orders/${currentUserId}/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cart_items: cartItems,
                        delivery_address: "123 Main St, Delhi", // You can make this dynamic
                        delivery_instructions: "Please deliver during business hours"
                    })
                });
                
                if (orderResponse.ok) {
                    const order = await orderResponse.json();
                    
                    // Show order status bar with real order data
                    currentOrder = order;
                    showOrderStatusBar(order, 'grace-period');
                    startGracePeriodCountdown(order);
                    
                    // Track ordered items during grace period
                    shoppingCart.forEach(item => {
                        addToOrderedItems(item.item_id);
                    });
                    
                    // Clear cart after successful order
                    shoppingCart = [];
                    updateCartCount();
                    closeCart();
                    
                    // Show success message with order details
                    const itemList = order.items.map(item => 
                        `${item.quantity} ${item.unit} ${item.item_name}`
                    ).join(', ');
                    
                    showAlert(`‚úÖ Order ${order.order_number} placed successfully! Items: ${itemList}`, 'success');
                    
                    // Refresh data
                    loadDashboard();
                    loadPredictions();
                    loadOrderHistory(); // Refresh order history
                    
                } else {
                    const errorData = await orderResponse.json();
                    showAlert(`Failed to place order: ${errorData.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Error placing cart order:', error);
                showAlert('Error placing order', 'error');
            }
        }

        // Helper functions for order display
        async function deleteOrderGroup(orderNumber, itemCount) {
            if (!confirm(`üóëÔ∏è Delete Order Confirmation\n\nAre you sure you want to delete Order ${orderNumber}?\n\nThis order contains ${itemCount} item${itemCount > 1 ? 's' : ''}.\n\n‚úÖ Benefits of deletion:\n‚Ä¢ Removes incorrect/duplicate orders\n‚Ä¢ Helps AI learn from your corrections\n‚Ä¢ Improves future predictions\n‚Ä¢ Cleans up order history\n\nThis action will trigger AI learning to adapt to your preferences.`)) {
                return;
            }
            
            try {
                // Check if this is the current active order
                console.log('Current order:', currentOrder);
                console.log('Order number to delete:', orderNumber);
                
                if (currentOrder && currentOrder.order_number === orderNumber) {
                    console.log('Deleting active order, clearing timers...');
                    
                    // Force cleanup everything
                    forceCleanupActiveOrder();
                    
                    showAlert(`Order ${orderNumber} cancelled and deleted! Timer cleared and suggestions restored.`, 'success');
                } else {
                    // Delete from order history
                    showAlert(`Order ${orderNumber} deleted from history!`, 'success');
                }
                
                // Refresh order history
                loadOrderHistory();
                
            } catch (error) {
                console.error('Error deleting order:', error);
                showAlert('Error deleting order. Please try again.', 'error');
            }
        }

        function reorderGroup(orderNumber) {
            showAlert(`Reorder feature for Order ${orderNumber} coming soon!`, 'info');
        }

        // Initialize predefined users manually
        async function initializePredefinedUsers() {
            try {
                console.log('Initializing predefined users...');
                const response = await fetch(`${API_BASE}/users/initialize-predefined`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`‚úÖ ${result.message}`, 'success');
                    
                    // Refresh the persona list
                    await loadAllPersonas();
                } else {
                    const errorData = await response.json();
                    showAlert(`‚ùå Error: ${errorData.error || 'Failed to initialize users'}`, 'error');
                }
            } catch (error) {
                console.error('Error initializing predefined users:', error);
                showAlert('‚ùå Error initializing predefined users', 'error');
            }
        }

        // Refresh persona list
        async function refreshPersonaList() {
            await loadAllPersonas();
            showAlert('üîÑ Persona list refreshed!', 'success');
        }

        // Debug function to test API connection
        async function testAPIConnection() {
            try {
                console.log('Testing API connection...');
                const response = await fetch(`${API_BASE}/users/`);
                console.log('API Response status:', response.status);
                
                if (response.ok) {
                    const users = await response.json();
                    console.log('API returned users:', users);
                    showAlert(`‚úÖ API working! Found ${users.length} users`, 'success');
                } else {
                    showAlert(`‚ùå API error: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('API connection failed:', error);
                showAlert(`‚ùå API connection failed: ${error.message}`, 'error');
            }
        }


        // Utility function to get unique items across categories and by item name
        function getUniqueItemsByCategory(items, maxItems = 6) {
            const categoryMap = new Map();
            const uniqueItems = [];
            const usedItemNames = new Set();
            
            // Group items by category
            items.forEach(item => {
                if (!categoryMap.has(item.category)) {
                    categoryMap.set(item.category, []);
                }
                categoryMap.get(item.category).push(item);
            });
            
            // Get one item from each category, cycling through categories
            const categories = Array.from(categoryMap.keys());
            let categoryIndex = 0;
            
            while (uniqueItems.length < maxItems && uniqueItems.length < items.length) {
                const currentCategory = categories[categoryIndex % categories.length];
                const categoryItems = categoryMap.get(currentCategory);
                
                if (categoryItems && categoryItems.length > 0) {
                    // Find the first item from this category that's not already selected
                    let itemIndex = 0;
                    let selectedItem = null;
                    
                    while (itemIndex < categoryItems.length) {
                        const item = categoryItems[itemIndex];
                        const itemKey = `${item.item_name}_${item.category}`.toLowerCase();
                        
                        if (!usedItemNames.has(itemKey)) {
                            selectedItem = item;
                            usedItemNames.add(itemKey);
                            categoryItems.splice(itemIndex, 1); // Remove from available items
                            break;
                        }
                        itemIndex++;
                    }
                    
                    if (selectedItem) {
                        uniqueItems.push(selectedItem);
                    }
                }
                
                categoryIndex++;
                
                // If we've gone through all categories and no more items, break
                if (categoryIndex >= categories.length && uniqueItems.length === 0) {
                    break;
                }
            }
            
            return uniqueItems;
        }

        // Additional function to ensure complete uniqueness by item name
        function getCompletelyUniqueItems(items, maxItems = 6) {
            const uniqueItems = [];
            const usedItemNames = new Set();
            
            // Sort items by urgency (high first) and then by days until empty
            const sortedItems = items.sort((a, b) => {
                if (a.urgency_level === 'high' && b.urgency_level !== 'high') return -1;
                if (b.urgency_level === 'high' && a.urgency_level !== 'high') return 1;
                return a.days_until_empty - b.days_until_empty;
            });
            
            for (const item of sortedItems) {
                if (uniqueItems.length >= maxItems) break;
                
                const itemKey = `${item.item_name}_${item.category}`.toLowerCase();
                if (!usedItemNames.has(itemKey)) {
                    uniqueItems.push(item);
                    usedItemNames.add(itemKey);
                }
            }
            
            return uniqueItems;
        }

        // Grace Period and Order Management
        let currentOrder = null;
        let gracePeriodInterval = null;
        let etaInterval = null;
        let deliveryTimerInterval = null;
        
        // Track ordered items during grace period to hide from suggestions
        let orderedItemsDuringGrace = new Set();
        
        // Function to filter out ordered items from suggestions
        function filterOrderedItems(items) {
            if (!currentOrder || !currentOrder.is_grace_period_active) {
                return items; // No active grace period, return all items
            }
            
            return items.filter(item => {
                const itemKey = `${item.item_id || item.id}`;
                return !orderedItemsDuringGrace.has(itemKey);
            });
        }
        
        // Function to add item to ordered items tracking
        function addToOrderedItems(itemId) {
            if (currentOrder && currentOrder.is_grace_period_active) {
                orderedItemsDuringGrace.add(itemId.toString());
                console.log('Added item to ordered tracking:', itemId);
            }
        }
        
        // Function to clear ordered items tracking (when order is cancelled or completed)
        function clearOrderedItems() {
            orderedItemsDuringGrace.clear();
            console.log('Cleared ordered items tracking');
        }
        
        // Function to check if an order is currently active
        function isOrderActive(orderNumber) {
            return currentOrder && currentOrder.order_number === orderNumber;
        }
        
        // Force cleanup function to ensure everything is cleared
        function forceCleanupActiveOrder() {
            console.log('Force cleaning up active order...');
            
            // Stop all timers
            stopOrderTimers();
            
            // Hide order status bar with animation
            const statusBar = document.getElementById('orderStatusBar');
            if (statusBar) {
                statusBar.style.transition = 'opacity 0.3s ease';
                statusBar.style.opacity = '0';
                setTimeout(() => {
                    statusBar.style.display = 'none';
                    statusBar.style.opacity = '1'; // Reset for next time
                }, 300);
            }
            
            // Clear ordered items tracking
            clearOrderedItems();
            
            // Clear current order
            currentOrder = null;
            
            // Force refresh UI
            setTimeout(() => {
                loadDashboard();
                if (currentTab === 'predictions') {
                    loadPredictions();
                }
                loadOrderHistory();
            }, 100);
            
            console.log('Force cleanup completed');
        }

        // Helper functions for order status display
        function getOrderStatusDisplay(status) {
            const statusMap = {
                'placed': 'üìù Placed',
                'confirmed': '‚úÖ Confirmed',
                'preparing': 'üë®‚Äçüç≥ Preparing',
                'out_for_delivery': 'üöö Out for Delivery',
                'delivering': 'üöõ Delivering',
                'delivered': '‚úÖ Delivered',
                'cancelled': '‚ùå Cancelled'
            };
            return statusMap[status] || 'üìù Placed';
        }

        function getOrderStatusClass(status) {
            return status || 'placed';
        }

        // Show order status bar
        function showOrderStatusBar(order, status) {
            const statusBar = document.getElementById('orderStatusBar');
            const statusTitle = document.getElementById('orderStatusTitle');
            const statusDetails = document.getElementById('orderStatusDetails');
            const statusTimer = document.getElementById('orderStatusTimer');
            const cancelButton = statusBar.querySelector('button');
            
            // Remove existing classes
            statusBar.className = 'order-status-bar';
            
            if (status === 'grace-period') {
                statusBar.classList.add('grace-period');
                statusTitle.textContent = `Order #${order.order_number}`;
                statusDetails.textContent = 'Grace time is active - you can add more items! (Or cancel from Order History)';
                statusTimer.textContent = '--:--';
                cancelButton.style.display = 'block';
                
                // Show estimated delivery time if available
                if (order.estimated_delivery_time) {
                    const deliveryTime = new Date(order.estimated_delivery_time);
                    const now = new Date();
                    const timeDiff = Math.max(0, deliveryTime - now);
                    const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (hours > 0) {
                        statusDetails.textContent += ` | ETA: ${hours}h ${minutes}m`;
                    } else {
                        statusDetails.textContent += ` | ETA: ${minutes}m`;
                    }
                }
            } else if (status === 'eta-display') {
                statusBar.classList.add('eta-display');
                statusTitle.textContent = `Order #${order.order_number}`;
                statusDetails.textContent = 'ETA for the order is being calculated...';
                statusTimer.textContent = '--:--';
                cancelButton.style.display = 'block';
            } else if (status === 'delivering') {
                statusBar.classList.add('delivering');
                statusTitle.textContent = `Order #${order.order_number}`;
                statusDetails.textContent = 'Your order is on the way!';
                statusTimer.textContent = '--:--';
                cancelButton.style.display = 'block';
            } else if (status === 'delivered') {
                statusBar.classList.add('delivered');
                statusTitle.textContent = `Order #${order.order_number}`;
                statusDetails.textContent = 'Order delivered successfully!';
                statusTimer.textContent = 'Delivered';
                cancelButton.style.display = 'none';
            }
            
            statusBar.style.display = 'block';
        }

        // Hide order status bar
        function hideOrderStatusBar() {
            const statusBar = document.getElementById('orderStatusBar');
            if (statusBar) {
                statusBar.style.display = 'none';
                console.log('Order status bar hidden');
            } else {
                console.log('Order status bar not found');
            }
        }

        // Stop all order timers and cleanup
        function stopOrderTimers() {
            if (gracePeriodInterval) {
                clearInterval(gracePeriodInterval);
                gracePeriodInterval = null;
            }
            if (etaInterval) {
                clearInterval(etaInterval);
                etaInterval = null;
            }
        }

        // Check if current order is still valid and cleanup if needed
        function validateCurrentOrder() {
            if (currentOrder) {
                // Check if order status bar is still visible
                const statusBar = document.getElementById('orderStatusBar');
                if (statusBar && statusBar.style.display === 'none') {
                    // Order status was hidden, cleanup
                    stopOrderTimers();
                    currentOrder = null;
                }
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopOrderTimers();
        });

        // Periodic validation of current order (every 30 seconds)
        setInterval(validateCurrentOrder, 30000);

        // Start grace period countdown
        function startGracePeriodCountdown(order) {
            if (gracePeriodInterval) {
                clearInterval(gracePeriodInterval);
            }
            
            const gracePeriodEnd = new Date(order.grace_period_ends);
            const now = new Date();
            let timeLeft = Math.max(0, gracePeriodEnd - now);
            
            const updateGracePeriodDisplay = () => {
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                // Calculate delivery time remaining
                let deliveryInfo = '';
                if (order.estimated_delivery_time) {
                    const deliveryTime = new Date(order.estimated_delivery_time);
                    const now = new Date();
                    const deliveryTimeLeft = Math.max(0, deliveryTime - now);
                    const deliveryHours = Math.floor(deliveryTimeLeft / (1000 * 60 * 60));
                    const deliveryMinutes = Math.floor((deliveryTimeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (deliveryHours > 0) {
                        deliveryInfo = ` | ETA: ${deliveryHours}h ${deliveryMinutes}m`;
                    } else {
                        deliveryInfo = ` | ETA: ${deliveryMinutes}m`;
                    }
                }
                
                document.getElementById('orderStatusDetails').textContent = `Grace time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}${deliveryInfo}`;
                document.getElementById('orderStatusTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    // Grace period ended, switch to delivery timer
                    clearInterval(gracePeriodInterval);
                    
                    // Keep ordered items hidden since order is confirmed
                    // (Don't clear orderedItemsDuringGrace here)
                    
                    startDeliveryTimer(order);
                } else {
                    timeLeft -= 1000;
                }
            };
            
            updateGracePeriodDisplay();
            gracePeriodInterval = setInterval(updateGracePeriodDisplay, 1000);
        }

        // Start delivery timer after grace period ends
        function startDeliveryTimer(order) {
            // Update order status to delivering
            order.status = 'delivering';
            showOrderStatusBar(order, 'delivering');
            
            // Calculate estimated delivery time (simulate 20-30 minutes)
            const estimatedDeliveryMinutes = Math.floor(Math.random() * 15) + 20; // 20-35 minutes
            const deliveryEndTime = new Date(Date.now() + estimatedDeliveryMinutes * 60 * 1000);
            order.estimated_delivery_time = deliveryEndTime;
            
            let timeLeft = estimatedDeliveryMinutes * 60; // Convert to seconds
            
            const updateDeliveryDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('orderStatusDetails').textContent = `Estimated delivery in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('orderStatusTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    // Delivery completed
                    clearInterval(deliveryTimerInterval);
                    order.status = 'delivered';
                    order.actual_delivery_time = new Date();
                    showOrderDelivered(order);
                } else {
                    timeLeft--;
                }
            };
            
            updateDeliveryDisplay();
            deliveryTimerInterval = setInterval(updateDeliveryDisplay, 1000);
        }

        // Show ETA for order (legacy function for compatibility)
        function showETAForOrder(order) {
            startDeliveryTimer(order);
        }

        // Show order delivered
        function showOrderDelivered(order) {
            showOrderStatusBar(order, 'delivered');
            
            // Clear ordered items tracking since order is completed
            clearOrderedItems();
            
            // Hide status bar after 5 seconds
            setTimeout(() => {
                hideOrderStatusBar();
                stopOrderTimers();
                currentOrder = null;
                showAlert('üéâ Order delivered successfully!', 'success');
                
                // Refresh dashboard to show any new suggestions
                setTimeout(() => {
                    loadDashboard();
                    if (currentTab === 'predictions') {
                        loadPredictions();
                    }
                }, 1000);
            }, 5000);
        }

        // Stop all order timers
        function stopOrderTimers() {
            console.log('Stopping all order timers...');
            
            if (gracePeriodInterval) {
                clearInterval(gracePeriodInterval);
                gracePeriodInterval = null;
                console.log('Grace period timer stopped');
            }
            if (etaInterval) {
                clearInterval(etaInterval);
                etaInterval = null;
                console.log('ETA timer stopped');
            }
            if (deliveryTimerInterval) {
                clearInterval(deliveryTimerInterval);
                deliveryTimerInterval = null;
                console.log('Delivery timer stopped');
            }
            
            console.log('All timers stopped');
        }

        // Cancel current order
        function cancelCurrentOrder() {
            if (currentOrder) {
                if (confirm(`Are you sure you want to cancel order #${currentOrder.order_number}?`)) {
                    stopOrderTimers();
                    hideOrderStatusBar();
                    
                    // Clear ordered items tracking to restore suggestions
                    clearOrderedItems();
                    
                    currentOrder.status = 'cancelled';
                    currentOrder = null;
                    showAlert('Order cancelled successfully. Suggestions have been restored!', 'info');
                    
                    // Refresh dashboard to show restored suggestions
                    setTimeout(() => {
                        loadDashboard();
                        if (currentTab === 'predictions') {
                            loadPredictions();
                        }
                    }, 500);
                }
            }
        }





         // Edit Item Functions
         function editItem(itemId) {
             // Find the item in the current items list
             const item = currentItems.find(i => i.id === itemId);
             if (!item) {
                 showAlert('Item not found!', 'error');
                 return;
             }
             
             // Populate the edit form
             document.getElementById('edit-item-name').value = item.name;
             document.getElementById('edit-item-category').value = item.category;
             document.getElementById('edit-item-quantity').value = item.quantity;
             document.getElementById('edit-item-consumption').value = item.consumption_rate;
             document.getElementById('edit-item-brand').value = item.brand || '';
             document.getElementById('edit-quantity-unit').textContent = item.unit;
             
             // Store the item ID for the form submission
             document.getElementById('edit-item-form').dataset.itemId = itemId;
             
             // Show the modal
             document.getElementById('edit-item-modal').style.display = 'flex';
         }

         function closeEditItemModal() {
             document.getElementById('edit-item-modal').style.display = 'none';
             document.getElementById('edit-item-form').reset();
             delete document.getElementById('edit-item-form').dataset.itemId;
         }

         // Handle edit form submission
         document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             const itemId = parseInt(document.getElementById('edit-item-form').dataset.itemId);
             const formData = {
                 quantity: parseFloat(document.getElementById('edit-item-quantity').value),
                 consumption_rate: parseFloat(document.getElementById('edit-item-consumption').value),
                 brand: document.getElementById('edit-item-brand').value || "Local"
             };
             
             try {
                 const response = await fetch(`${API_BASE}/items/${itemId}?user_id=${currentUserId}`, {
                     method: 'PUT',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(formData)
                 });
                 
                 if (response.ok) {
                     showAlert('Item updated successfully! ‚úèÔ∏è', 'success');
                     closeEditItemModal();
                     loadItems();
                     loadDashboard();
                     loadPredictions();
                 } else {
                     showAlert('Error updating item', 'error');
                 }
             } catch (error) {
                 console.error('Error updating item:', error);
                 showAlert('Error updating item', 'error');
             }
         });

         // Delete Order Function
         async function deleteOrder(orderId, itemName) {
             if (!confirm(`üóëÔ∏è Delete Order Confirmation\n\nAre you sure you want to delete this order for "${itemName}"?\n\n‚úÖ Benefits of deletion:\n‚Ä¢ Removes incorrect/duplicate orders\n‚Ä¢ Helps AI learn from your corrections\n‚Ä¢ Improves future predictions\n‚Ä¢ Cleans up order history\n\nThis action will trigger AI learning to adapt to your preferences.`)) {
                 return;
             }

             try {
                 const response = await fetch(`${API_BASE}/order-history/${orderId}?user_id=${currentUserId}`, {
                     method: 'DELETE'
                 });
                 
                 if (response.ok) {
                     showAlert(`‚úÖ Order for "${itemName}" deleted successfully!\n\nüß† The AI is now learning from this correction to improve future predictions.`, 'success');
                     
                     // Check if this deletion affects the current active order
                     if (currentOrder && currentOrder.id === orderId) {
                         // Stop all timers and hide status bar
                         stopOrderTimers();
                         hideOrderStatusBar();
                         currentOrder = null;
                         showAlert('Order status cleared due to order deletion', 'info');
                     }
                     
                     // Refresh order history
                     loadOrderHistory();
                     
                     // Show AI learning notice
                     const learningNotice = document.getElementById('deletion-learning-notice');
                     if (learningNotice) {
                         learningNotice.style.display = 'block';
                         
                         // Hide the notice after 5 seconds
                         setTimeout(() => {
                             learningNotice.style.display = 'none';
                         }, 5000);
                     }
                     
                     // Trigger AI learning to adapt to the deletion
                     setTimeout(() => {
                         // AI training is now automatic - no need to manually trigger
                         console.log('üß† AI training automatically triggered after order deletion');
                     }, 1000);
                     
                     // Show AI learning status after a delay
                     setTimeout(() => {
                         showAILearningStatus();
                     }, 3000);
                     
                 } else if (response.status === 404) {
                     showAlert(`‚ö†Ô∏è Order deletion endpoint not found.\n\nThis feature requires backend support. The order will remain in your history for now.`, 'error');
                 } else if (response.status === 405) {
                     showAlert(`‚ö†Ô∏è Order deletion not supported yet.\n\nThis feature is coming soon! For now, you can use the "Learn from Orders" button to improve AI predictions.`, 'error');
                 } else {
                     showAlert('‚ùå Error deleting order', 'error');
                 }
             } catch (error) {
                 console.error('Error deleting order:', error);
                 
                 // Check if it's a network error or endpoint doesn't exist
                 if (error.name === 'TypeError' && error.message.includes('fetch')) {
                     showAlert(`‚ö†Ô∏è Order deletion feature not available yet.\n\nThis feature requires backend support. You can still use "Learn from Orders" to improve AI predictions.`, 'error');
                 } else {
                     showAlert('‚ùå Error deleting order', 'error');
                 }
             }
         }

         // Reorder Item Function
         function reorderItem(itemName, quantity, unit, category) {
             // Add the item to cart for reordering
             const cartItem = {
                 item_id: `reorder_${Date.now()}`,
                 item_name: itemName,
                 category: category,
                 quantity: quantity,
                 unit: unit,
                 suggested_quantity: quantity,
                 is_reorder: true,
                 brand: "Local" // Default brand for reorders
             };
             
             addToCart(cartItem);
             
             // Show cart to user
             toggleCart();
             
             showAlert(`Added ${itemName} to cart for reordering! üõí`, 'success');
         }

        // Enhanced persona management
        let allPersonas = [];
        let customPersonas = [];

        // Clear any loading overlays
        function clearLoadingOverlays() {
            // Remove any loading overlays that might be covering the screen
            const loadingOverlays = document.querySelectorAll('.loading-overlay, .loading-screen, .loading-personas');
            loadingOverlays.forEach(overlay => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            });
            
            // Also clear any elements with loading text that might be covering the screen
            const loadingElements = document.querySelectorAll('[class*="loading"], [id*="loading"]');
            loadingElements.forEach(element => {
                if (element.textContent.includes('Loading') && element.style.position === 'fixed') {
                    element.style.display = 'none';
                }
            });
            
            // Force show the main content
            const mainContent = document.querySelector('.main-content, .categories-section, .products-grid');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
        }

        // Load all personas on page load
        async function loadAllPersonas() {
            try {
                console.log('Loading personas from API...');
                const response = await fetch(`${API_BASE}/users/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const users = await response.json();
                console.log('Loaded users from API:', users);
                allPersonas = users;
                
                // Separate predefined and custom personas
                const predefinedUsernames = ['rahul_single', 'priya_amit_couple', 'patel_family', 'sharma_joint_family', 'student_hostel_delhi'];
                
                const predefined = users.filter(u => predefinedUsernames.includes(u.username));
                customPersonas = users.filter(u => !predefinedUsernames.includes(u.username));
                
                console.log('Predefined personas found:', predefined);
                console.log('Custom personas found:', customPersonas);
                console.log('Expected predefined usernames:', predefinedUsernames);
                
                // Clear any loading overlays
                clearLoadingOverlays();
                
                // Render persona dropdown
                renderPersonaDropdown(predefined, customPersonas);
                
                // Set default persona if none selected
                if (!currentUser || !users.find(u => u.username === currentUser)) {
                    if (predefined.length > 0) {
                        console.log('Setting default persona:', predefined[0].username);
                        switchAccount(predefined[0].username);
                    } else if (users.length > 0) {
                        console.log('No predefined personas, using first available user:', users[0].username);
                        switchAccount(users[0].username);
                    }
                }
            } catch (error) {
                console.error('Error loading personas:', error);
                console.log('Falling back to hardcoded personas');
                // Clear any loading overlays
                clearLoadingOverlays();
                // Fallback to hardcoded personas
                renderFallbackPersonas();
            }
        }

        function renderPersonaDropdown(predefined, custom) {
            const dropdown = document.getElementById('account-dropdown');
            
            let html = '';
            
            // Clear loading state
            console.log('Rendering persona dropdown with:', predefined.length, 'predefined and', custom.length, 'custom personas');
            
            // Predefined personas section
            if (predefined.length > 0) {
                html += '<div class="persona-section">';
                html += '<div class="persona-section-title">üìã Predefined Personas</div>';
                
                predefined.forEach(persona => {
                    const isActive = currentUser === persona.username ? 'active' : '';
                    const icon = getPersonaIcon(persona.username);
                    html += `<div class="account-option ${isActive}" onclick="switchAccount('${persona.username}')">
                        <div class="persona-info">
                            <div class="persona-name">${icon} ${persona.display_name}</div>
                            <div class="persona-details">${persona.household_size} person${persona.household_size > 1 ? 's' : ''} ‚Ä¢ ${persona.description || 'Standard persona'}</div>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
            }
            
            // Custom personas section
            if (custom.length > 0) {
                html += '<div class="persona-section">';
                html += '<div class="persona-section-title">‚ú® Custom Personas</div>';
                
                custom.forEach(persona => {
                    const isActive = currentUser === persona.username ? 'active' : '';
                    html += `<div class="account-option custom-persona-item ${isActive}" onclick="switchAccount('${persona.username}')">
                        <div class="persona-info">
                            <div class="persona-name">üë§ ${persona.display_name}</div>
                            <div class="persona-details">${persona.household_size} person${persona.household_size > 1 ? 's' : ''} ‚Ä¢ Custom persona</div>
                        </div>
                        <div class="persona-actions">
                            <button onclick="deleteCustomPersona('${persona.username}', ${persona.id}, '${persona.display_name}')" 
                                    class="delete-persona-btn" title="Delete this persona">üóëÔ∏è</button>
                        </div>
                    </div>`;
                });
                
                html += '</div>';
            }
            
            // Utility buttons
            html += '<div class="persona-section">';
            html += '<div class="persona-section-title">üîß Utilities</div>';
            html += `<div class="account-option" onclick="initializePredefinedUsers()">
                <div class="persona-info">
                    <div class="persona-name">üîÑ Initialize Predefined Users</div>
                    <div class="persona-details">Create all predefined personas if missing</div>
                </div>
            </div>`;
            html += `<div class="account-option" onclick="refreshPersonaList()">
                <div class="persona-info">
                    <div class="persona-name">üîÑ Refresh Persona List</div>
                    <div class="persona-details">Reload all personas from database</div>
                </div>
            </div>`;
            html += `<div class="account-option" onclick="testAPIConnection()">
                <div class="persona-info">
                    <div class="persona-name">üîç Test API Connection</div>
                    <div class="persona-details">Check if backend is working</div>
                </div>
            </div>`;
            html += `<div class="account-option" onclick="showCustomPersonaForm()">
                <div class="persona-info">
                    <div class="persona-name">‚ûï Add Custom Persona</div>
                    <div class="persona-details">Create your own personalized persona</div>
                </div>
            </div>`;
            html += '</div>';
            
            // Always add the custom persona button at the end
            html += '<div class="account-option" onclick="showCustomPersonaForm()" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">';
            html += '‚ûï Add Custom Persona';
            html += '</div>';
            
            // If no personas found, show a message
            if (predefined.length === 0 && custom.length === 0) {
                html = `
                    <div class="persona-section">
                        <div class="persona-section-title">‚ö†Ô∏è No Personas Found</div>
                        <div class="account-option" onclick="initializePredefinedUsers()">
                            <div class="persona-info">
                                <div class="persona-name">üîÑ Initialize Predefined Users</div>
                                <div class="persona-details">Click to create all predefined personas</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            dropdown.innerHTML = html;
        }

        function renderFallbackPersonas() {
            const dropdown = document.getElementById('account-dropdown');
            dropdown.innerHTML = `
                <div class="account-option active" onclick="switchAccount('rahul_single')">
                    <div class="persona-info">
                        <div class="persona-name">üë§ Rahul</div>
                        <div class="persona-details">1 person ‚Ä¢ Young professional living alone</div>
                    </div>
                </div>
                <div class="account-option" onclick="switchAccount('priya_amit_couple')">
                    <div class="persona-info">
                        <div class="persona-name">üë´ Priya & Amit</div>
                        <div class="persona-details">2 people ‚Ä¢ Young married couple</div>
                    </div>
                </div>
                <div class="account-option" onclick="switchAccount('patel_family')">
                    <div class="persona-info">
                        <div class="persona-name">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ The Patel Family</div>
                        <div class="persona-details">4 people ‚Ä¢ Family with 2 kids</div>
                    </div>
                </div>
                <div class="account-option" onclick="switchAccount('sharma_joint_family')">
                    <div class="persona-info">
                        <div class="persona-name">üë®‚Äçüë©‚Äçüëß‚Äçüë¶üë¥üëµ Sharma Joint Family</div>
                        <div class="persona-details">6 people ‚Ä¢ Joint family with grandparents</div>
                    </div>
                </div>
                <div class="account-option" onclick="switchAccount('student_hostel_delhi')">
                    <div class="persona-info">
                        <div class="persona-name">üè† Delhi Student Hostel</div>
                        <div class="persona-details">8 people ‚Ä¢ Student hostel with 8 roommates</div>
                    </div>
                </div>
                <div class="account-option" onclick="showCustomPersonaForm()">‚ûï Add Custom Persona</div>
            `;
        }

        function getPersonaIcon(username) {
            const icons = {
                'rahul_single': 'üë§',
                'priya_amit_couple': 'üë´',
                'patel_family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'sharma_joint_family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶üë¥üëµ',
                'student_hostel_delhi': 'üè†'
            };
            return icons[username] || 'üë§';
        }

        // Check backend connection
        async function checkBackendConnection() {
            try {
                console.log('Testing backend connection to:', `${API_BASE}/users/`);
                const response = await fetch(`${API_BASE}/users/`);
                console.log('Backend response status:', response.status);
                if (response.ok) {
                    const users = await response.json();
                    console.log('Backend returned users:', users);
                }
                return response.ok;
            } catch (error) {
                console.error('Backend connection failed:', error);
                return false;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Clear any loading overlays immediately
            clearLoadingOverlays();
            
            // Also clear loading overlays after a timeout as a safety measure
            setTimeout(() => {
                clearLoadingOverlays();
            }, 2000);
            
            // Initialize theme
            initializeTheme();
            console.log('Theme initialized');
            
            // Check backend connection first
            console.log('Checking backend connection...');
            checkBackendConnection().then(isConnected => {
                console.log('Backend connected:', isConnected);
                if (!isConnected) {
                    console.warn('Backend not connected, using fallback personas');
                    renderFallbackPersonas();
                    return;
                }
                
                // Load all personas first
                console.log('Loading personas...');
                loadAllPersonas().then(() => {
                    console.log('Personas loaded, loading initial data...');
                    // Then load initial data
                    if (currentTab === 'dashboard') {
                        console.log('Loading dashboard...');
                        loadDashboard();
                    } else if (currentTab === 'predictions') {
                        console.log('Loading predictions...');
                        loadPredictions();
                    } else if (currentTab === 'manage') {
                        console.log('Loading items...');
                        loadItems();
                    }
                });
            });
            
            // Custom persona form submission
            document.getElementById('custom-persona-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createCustomPersona();
            });
        });

        // Delete custom persona
        async function deleteCustomPersona(username, userId, displayName) {
            // Prevent event bubbling
            event.stopPropagation();
            
            // Confirm deactivation with the correct, informative message
            if (!confirm(`Deactivate '${displayName}'?\n\nThis will hide the persona from the list. You can reactivate it later by creating a new persona with the same email.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    showAlert(`‚úÖ ${result.message}`, 'success');
                    
                    // If we're currently using this persona, switch to default
                    if (currentUser === username) {
                        // Find the first predefined persona to switch to
                        const firstPredefined = allPersonas.find(p => !p.username.startsWith('custom_'));
                        if (firstPredefined) {
                            switchAccount(firstPredefined.username);
                        }
                    }
                    // Refresh the persona list to remove the deactivated one
                    await loadAllPersonas();
                    
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to deactivate persona');
                }
                
            } catch (error) {
                console.error('Error deactivating persona:', error);
                showAlert(`Error deactivating persona: ${error.message}`, 'error');
            }
        }

        // Notification Management
        let notifications = [];
        let unreadCount = 0;

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                loadNotifications();
            }
        }

        function closeNotifications() {
            document.getElementById('notification-panel').classList.remove('show');
        }

        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/notifications/${currentUserId}`);
                notifications = await response.json();
                
                unreadCount = notifications.filter(n => !n.is_read).length;
                updateNotificationCount();
                
                renderNotifications();
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notification-content').innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>Error loading notifications</div>
                    </div>
                `;
            }
        }

        function renderNotifications() {
            const content = document.getElementById('notification-content');
            
            if (notifications.length === 0) {
                content.innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">üîî</div>
                        <div>No notifications yet</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.is_read ? 'unread' : ''} ${notification.priority === 'high' ? 'high-priority' : ''}" 
                     onclick="markNotificationRead(${notification.id})">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-meta">
                        <span class="notification-priority priority-${notification.priority}">${notification.priority}</span>
                        <span>${new Date(notification.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`${API_BASE}/notifications/${notificationId}/read?user_id=${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Update local state
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.is_read = true;
                        unreadCount = Math.max(0, unreadCount - 1);
                        updateNotificationCount();
                        renderNotifications();
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        function updateNotificationCount() {
            document.getElementById('notification-count').textContent = unreadCount;
        }

        async function createUrgentNotifications() {
            try {
                const response = await fetch(`${API_BASE}/notifications/${currentUserId}/create-urgent`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Created ${result.notifications.length} urgent notifications! üîî`, 'success');
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error creating urgent notifications:', error);
            }
        }

        // Budget Management
        function toggleBudgetModal() {
            document.getElementById('budget-modal').style.display = 'flex';
            loadBudgetStatus();
        }

        function closeBudgetModal() {
            document.getElementById('budget-modal').style.display = 'none';
        }

        async function loadBudgetStatus() {
            try {
                const response = await fetch(`${API_BASE}/budgets/${currentUserId}/status`);
                const status = await response.json();
                
                const statusDiv = document.getElementById('budget-status');
                
                if (status.total_budget === 0) {
                    statusDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üí∞</div>
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">No Budget Set</div>
                            <div style="color: #666; font-size: 0.9rem;">Set a monthly budget to track your spending</div>
                        </div>
                    `;
                } else {
                    const statusColor = status.status === 'critical' ? '#dc3545' : 
                                      status.status === 'warning' ? '#ffc107' : 
                                      status.status === 'moderate' ? '#17a2b8' : '#28a745';
                    
                    statusDiv.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #333;">Budget Status</h4>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">
                                    ${status.status}
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #333;">‚Çπ${status.total_budget.toFixed(0)}</div>
                                    <div style="font-size: 0.8rem; color: #666;">Total Budget</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #dc3545;">‚Çπ${status.total_spent.toFixed(0)}</div>
                                    <div style="font-size: 0.8rem; color: #666;">Spent</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #28a745;">‚Çπ${status.remaining.toFixed(0)}</div>
                                    <div style="font-size: 0.8rem; color: #666;">Remaining</div>
                                </div>
                            </div>
                            
                            <div style="background: #e9ecef; border-radius: 10px; height: 8px; margin-bottom: 15px;">
                                <div style="background: ${statusColor}; height: 100%; border-radius: 10px; width: ${status.spending_percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                            
                            <div style="text-align: center; color: #666; font-size: 0.9rem;">
                                ${status.spending_percentage.toFixed(1)}% of budget used
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading budget status:', error);
                document.getElementById('budget-status').innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 8px; color: #721c24;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚ùå</div>
                        <div>Error loading budget status</div>
                    </div>
                `;
            }
        }

        // Budget form submission
        document.getElementById('budget-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const budgetAmount = parseFloat(document.getElementById('budget-amount').value);
            const category = document.getElementById('budget-category').value || null;
            
            try {
                const response = await fetch(`${API_BASE}/budgets/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        budget_amount: budgetAmount,
                        month: new Date().toISOString().slice(0, 7), // YYYY-MM format
                        category: category
                    })
                });
                
                if (response.ok) {
                    showAlert('Budget set successfully! üí∞', 'success');
                    closeBudgetModal();
                    loadBudgetStatus();
                } else {
                    showAlert('Error setting budget', 'error');
                }
            } catch (error) {
                console.error('Error setting budget:', error);
                showAlert('Error setting budget', 'error');
            }
        });

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle icon
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            showAlert(`Switched to ${newTheme} mode!`, 'success');
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update theme toggle icon
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Recommendations Management
        let currentRecommendationType = 'all';

        async function loadRecommendations(type) {
            currentRecommendationType = type;
            
            // Update button states
            document.querySelectorAll('[id$="-btn"]').forEach(btn => {
                btn.classList.remove('btn');
                btn.classList.add('btn-secondary');
            });
            document.getElementById(`${type}-btn`).classList.remove('btn-secondary');
            document.getElementById(`${type}-btn`).classList.add('btn');
            
            // Hide all recommendation sections
            document.querySelectorAll('[id$="-recommendations"], #all-recommendations').forEach(section => {
                section.style.display = 'none';
            });
            
            try {
                if (type === 'seasonal') {
                    await loadSeasonalRecommendations();
                } else if (type === 'trending') {
                    await loadTrendingRecommendations();
                } else if (type === 'smart') {
                    await loadSmartRecommendations();
                } else {
                    await loadAllRecommendations();
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                showAlert('Error loading recommendations', 'error');
            }
        }

        async function loadSeasonalRecommendations() {
            const response = await fetch(`${API_BASE}/recommendations/${currentUserId}/seasonal?category=${currentCategory === 'all' ? '' : currentCategory}`);
            const data = await response.json();
            
            document.getElementById('seasonal-recommendations').style.display = 'block';
            const content = document.getElementById('seasonal-content');
            
            if (data.recommendations && Object.keys(data.recommendations).length > 0) {
                let html = `<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <strong>üçÇ ${data.message}</strong>
                </div>`;
                
                for (const [category, items] of Object.entries(data.recommendations)) {
                    if (items.length > 0) {
                        html += `<div style="margin-bottom: 20px;">
                            <h5 style="color: #333; margin-bottom: 10px;">${category}</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                ${items.map(item => `
                                    <div class="item-box" onclick="addRecommendationToCart('${item}', '${category}')">
                                        <div class="item-name">${item}</div>
                                        <div class="category-badge">${category}</div>
                                        <div style="font-size: 0.8rem; color: #28a745; margin-top: 5px;">üçÇ Seasonal</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }
                }
                
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="loading"><div class="loading-icon">üçÇ</div><div>No seasonal recommendations available</div></div>';
            }
        }

        async function loadTrendingRecommendations() {
            const response = await fetch(`${API_BASE}/recommendations/${currentUserId}/trending?trend_type=health`);
            const data = await response.json();
            
            document.getElementById('trending-recommendations').style.display = 'block';
            const content = document.getElementById('trending-content');
            
            if (data.recommendations && data.recommendations.length > 0) {
                const html = `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>üìà ${data.message}</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${data.recommendations.map(item => `
                        <div class="item-box" onclick="addRecommendationToCart('${item}', 'Health')">
                            <div class="item-name">${item}</div>
                            <div class="category-badge">Health</div>
                            <div style="font-size: 0.8rem; color: #ffc107; margin-top: 5px;">üìà Trending</div>
                        </div>
                    `).join('')}
                </div>`;
                
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="loading"><div class="loading-icon">üìà</div><div>No trending items available</div></div>';
            }
        }

        async function loadSmartRecommendations() {
            const response = await fetch(`${API_BASE}/recommendations/${currentUserId}/smart?category=${currentCategory === 'all' ? '' : currentCategory}`);
            const data = await response.json();
            
            document.getElementById('smart-recommendations').style.display = 'block';
            const content = document.getElementById('smart-content');
            
            if (data.personalized && data.personalized.length > 0) {
                const html = `<div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                    <strong>üß† Personalized recommendations based on your preferences</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                    ${data.personalized.map(item => `
                        <div class="item-box" onclick="addRecommendationToCart('${item.name}', '${item.category}')">
                            <div class="item-name">${item.name}</div>
                            <div class="category-badge">${item.category}</div>
                            <div style="font-size: 0.8rem; color: #17a2b8; margin-top: 5px;">${item.reason}</div>
                        </div>
                    `).join('')}
                </div>`;
                
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="loading"><div class="loading-icon">üß†</div><div>No personalized recommendations available</div></div>';
            }
        }

        async function loadAllRecommendations() {
            document.getElementById('all-recommendations').style.display = 'block';
            const content = document.getElementById('all-content');
            
            try {
                const [seasonalRes, trendingRes, smartRes] = await Promise.all([
                    fetch(`${API_BASE}/recommendations/${currentUserId}/seasonal`),
                    fetch(`${API_BASE}/recommendations/${currentUserId}/trending`),
                    fetch(`${API_BASE}/recommendations/${currentUserId}/smart`)
                ]);
                
                const seasonal = await seasonalRes.json();
                const trending = await trendingRes.json();
                const smart = await smartRes.json();
                
                let html = '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">';
                
                // Seasonal section
                html += `<div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                    <h5 style="color: #333; margin-bottom: 10px;">üçÇ Seasonal</h5>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">${seasonal.message}</div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${Object.entries(seasonal.recommendations || {}).map(([cat, items]) => 
                            items.slice(0, 3).map(item => `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">${item}</div>`).join('')
                        ).join('')}
                    </div>
                </div>`;
                
                // Trending section
                html += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <h5 style="color: #333; margin-bottom: 10px;">üìà Trending</h5>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">${trending.message}</div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${(trending.recommendations || []).slice(0, 5).map(item => 
                            `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">${item}</div>`
                        ).join('')}
                    </div>
                </div>`;
                
                // Smart section
                html += `<div style="background: #d1ecf1; padding: 15px; border-radius: 8px;">
                    <h5 style="color: #333; margin-bottom: 10px;">üß† Smart</h5>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Personalized for you</div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${(smart.personalized || []).slice(0, 5).map(item => 
                            `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">${item.name}</div>`
                        ).join('')}
                    </div>
                </div>`;
                
                html += '</div>';
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = '<div class="loading"><div class="loading-icon">‚ùå</div><div>Error loading recommendations</div></div>';
            }
        }

        function addRecommendationToCart(itemName, category) {
            const cartItem = {
                item_id: `rec_${Date.now()}`,
                item_name: itemName,
                category: category,
                quantity: 1,
                unit: 'pieces',
                suggested_quantity: 1,
                is_recommendation: true,
                brand: "Recommended"
            };
            
            addToCart(cartItem);
            showAlert(`Added ${itemName} to cart! üõí`, 'success');
        }

        // Smart Shopping List Management
        async function generateSmartShoppingList() {
            const daysAhead = parseInt(document.getElementById('days-ahead').value);
            const content = document.getElementById('shopping-list-content');
            
            // Show loading state
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-icon">üõí</div>
                    <div>Generating smart shopping list for ${daysAhead} days...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/shopping-list/${currentUserId}/generate?days_ahead=${daysAhead}`);
                const shoppingList = await response.json();
                
                renderSmartShoppingList(shoppingList);
                
            } catch (error) {
                console.error('Error generating shopping list:', error);
                content.innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>Error generating shopping list</div>
                    </div>
                `;
            }
        }

        function renderSmartShoppingList(shoppingList) {
            const content = document.getElementById('shopping-list-content');
            
            let html = `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">üõí Your Smart Shopping List</h4>
                        <div style="background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                            ‚Çπ${shoppingList.budget_estimate.toFixed(0)} estimated
                        </div>
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        Generated for ${shoppingList.estimated_days_coverage} days ahead ‚Ä¢ ${new Date(shoppingList.generated_at).toLocaleDateString()}
                    </div>
                </div>
            `;
            
            // Urgent items
            if (shoppingList.urgent_items.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">üö® Urgent Items (${shoppingList.urgent_items.length})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            ${shoppingList.urgent_items.map(item => `
                                <div class="product-card" style="border-left: 4px solid #dc3545;">
                                    <div class="product-header">
                                        <div>
                                            <div class="product-title">${item.name}</div>
                                            <div class="product-category">${item.category}</div>
                                        </div>
                                        <span class="urgency-badge high">${item.urgency_level}</span>
                                    </div>
                                    <div class="product-details">
                                        <div class="product-detail">
                                            <span class="detail-label">Current:</span>
                                            <span class="detail-value">${item.current_quantity} ${item.unit}</span>
                                        </div>
                                        <div class="product-detail">
                                            <span class="detail-label">Suggested:</span>
                                            <span class="detail-value">${item.suggested_quantity} ${item.unit}</span>
                                        </div>
                                        <div class="product-detail">
                                            <span class="detail-label">Reason:</span>
                                            <span class="detail-value">${item.reason}</span>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button onclick="addShoppingListItemToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="btn">
                                            üõí Add to Cart
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Recommended items
            if (shoppingList.recommended_items.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #ffc107; margin-bottom: 15px;">‚ö†Ô∏è Recommended Items (${shoppingList.recommended_items.length})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                            ${shoppingList.recommended_items.map(item => `
                                <div class="product-card" style="border-left: 4px solid #ffc107;">
                                    <div class="product-header">
                                        <div>
                                            <div class="product-title">${item.name}</div>
                                            <div class="product-category">${item.category}</div>
                                        </div>
                                        <span class="urgency-badge medium">${item.urgency_level}</span>
                                    </div>
                                    <div class="product-details">
                                        <div class="product-detail">
                                            <span class="detail-label">Current:</span>
                                            <span class="detail-value">${item.current_quantity} ${item.unit}</span>
                                        </div>
                                        <div class="product-detail">
                                            <span class="detail-label">Suggested:</span>
                                            <span class="detail-value">${item.suggested_quantity} ${item.unit}</span>
                                        </div>
                                        <div class="product-detail">
                                            <span class="detail-label">Reason:</span>
                                            <span class="detail-value">${item.reason}</span>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button onclick="addShoppingListItemToCart(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="btn">
                                            üõí Add to Cart
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Seasonal suggestions
            if (shoppingList.seasonal_suggestions.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #17a2b8; margin-bottom: 15px;">üçÇ Seasonal Suggestions (${shoppingList.seasonal_suggestions.length})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                            ${shoppingList.seasonal_suggestions.map(item => `
                                <div class="item-box" onclick="addSeasonalItemToCart('${item.name}', '${item.category}')">
                                    <div class="item-name">${item.name}</div>
                                    <div class="category-badge">${item.category}</div>
                                    <div style="font-size: 0.8rem; color: #17a2b8; margin-top: 5px;">${item.reason}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Summary
            html += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">üìä Shopping List Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #dc3545;">${shoppingList.urgent_items.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Urgent Items</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #ffc107;">${shoppingList.recommended_items.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Recommended</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #17a2b8;">${shoppingList.seasonal_suggestions.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Seasonal</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #28a745;">‚Çπ${shoppingList.budget_estimate.toFixed(0)}</div>
                            <div style="font-size: 0.9rem; color: #666;">Est. Cost</div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function generateMealPlan() {
            const content = document.getElementById('meal-plan-content');
            const shoppingContent = document.getElementById('shopping-list-content');
            
            // Show meal plan content
            shoppingContent.style.display = 'none';
            content.style.display = 'block';
            
            // Show loading state
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-icon">üçΩÔ∏è</div>
                    <div>Generating weekly meal plan...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/shopping-list/${currentUserId}/meal-plan`);
                const mealPlan = await response.json();
                
                renderMealPlan(mealPlan);
                
            } catch (error) {
                console.error('Error generating meal plan:', error);
                content.innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>Error generating meal plan</div>
                    </div>
                `;
            }
        }

        function renderMealPlan(mealPlan) {
            const content = document.getElementById('meal-plan-content');
            
            let html = `
                <div style="background: #d1ecf1; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">üçΩÔ∏è Weekly Meal Plan</h4>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">Based on your available items</p>
                </div>
            `;
            
            // Meal suggestions
            for (const [mealType, suggestions] of Object.entries(mealPlan.meal_plan)) {
                if (suggestions.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h5 style="color: #333; margin-bottom: 15px; text-transform: capitalize;">${mealType} Options</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                ${suggestions.map(meal => `
                                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${meal}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Available items
            if (mealPlan.available_items.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h5 style="color: #333; margin-bottom: 15px;">üì¶ Available Items</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${mealPlan.available_items.map(item => `
                                <span style="background: #e9ecef; color: #495057; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">
                                    ${item.name} (${item.category})
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Shopping suggestions
            if (mealPlan.shopping_suggestions.length > 0) {
                html += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h5 style="color: #856404; margin: 0 0 10px 0;">üí° Shopping Suggestions</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #856404;">
                            ${mealPlan.shopping_suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function addShoppingListItemToCart(item) {
            const cartItem = {
                item_id: item.item_id,
                item_name: item.name,
                category: item.category,
                quantity: item.suggested_quantity,
                unit: item.unit,
                suggested_quantity: item.suggested_quantity,
                is_shopping_list: true,
                brand: "Smart List"
            };
            
            addToCart(cartItem);
            showAlert(`Added ${item.name} to cart! üõí`, 'success');
        }

        function addSeasonalItemToCart(itemName, category) {
            const cartItem = {
                item_id: `seasonal_${Date.now()}`,
                item_name: itemName,
                category: category,
                quantity: 1,
                unit: 'pieces',
                suggested_quantity: 1,
                is_seasonal: true,
                brand: "Seasonal"
            };
            
            addToCart(cartItem);
            showAlert(`Added ${itemName} to cart! üõí`, 'success');
        }

        // Smart Basket Management
        let smartBaskets = [];

        async function loadSmartBaskets() {
            const content = document.getElementById('smart-baskets-content');
            
            // Show loading state
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-icon">üõçÔ∏è</div>
                    <div>Loading your smart baskets...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${currentUserId}`);
                smartBaskets = await response.json();
                
                renderSmartBaskets();
                
            } catch (error) {
                console.error('Error loading smart baskets:', error);
                content.innerHTML = `
                    <div class="loading">
                        <div class="loading-icon">‚ùå</div>
                        <div>Error loading smart baskets</div>
                    </div>
                `;
            }
        }

        function renderSmartBaskets() {
            const content = document.getElementById('smart-baskets-content');
            
            if (smartBaskets.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üõçÔ∏è</div>
                        <h4 style="color: #333; margin-bottom: 10px;">No Smart Baskets Yet</h4>
                        <p style="color: #666; margin-bottom: 20px;">Create your first smart basket to automate your grocery shopping!</p>
                        <button onclick="showCreateBasketModal()" class="btn">‚ûï Create Your First Basket</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">ü§ñ AI-Managed Smart Baskets</h4>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        Your smart baskets automatically monitor consumption and add items to your cart when running low.
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
            `;
            
            smartBaskets.forEach(basket => {
                const statusColor = basket.auto_reorder_enabled ? '#28a745' : '#6c757d';
                const statusText = basket.auto_reorder_enabled ? 'Active' : 'Paused';
                const lastAdded = basket.last_auto_added ? new Date(basket.last_auto_added).toLocaleDateString() : 'Never';
                
                html += `
                    <div class="product-card" style="border-left: 4px solid ${statusColor};">
                        <div class="product-header">
                            <div>
                                <div class="product-title">${basket.basket_name}</div>
                                <div class="product-category">${basket.item_name} (${basket.item_category})</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    ${statusText}
                                </span>
                                <button onclick="editSmartBasket(${basket.id})" class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;">‚úèÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="product-details">
                            <div class="product-detail">
                                <span class="detail-label">Current Stock:</span>
                                <span class="detail-value">${basket.current_quantity} ${basket.current_unit}</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Reorder Threshold:</span>
                                <span class="detail-value">${basket.reorder_threshold_days} days before empty</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Quantity Range:</span>
                                <span class="detail-value">${basket.min_quantity} - ${basket.max_quantity} ${basket.current_unit}</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Auto-Added Count:</span>
                                <span class="detail-value">${basket.auto_add_count} times</span>
                            </div>
                            <div class="product-detail">
                                <span class="detail-label">Last Auto-Added:</span>
                                <span class="detail-value">${lastAdded}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="viewBasketHistory(${basket.id})" class="btn btn-secondary" style="flex: 1;">üìä History</button>
                            <button onclick="deleteSmartBasket(${basket.id})" class="btn" style="background: #dc3545; flex: 1;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        async function showCreateBasketModal() {
            document.getElementById('create-basket-modal').style.display = 'flex';
            
            // Load available items
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${currentUserId}/available-items`);
                const items = await response.json();
                
                const select = document.getElementById('basket-item');
                select.innerHTML = '<option value="">Select an item...</option>';
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${item.category}) - ${item.current_quantity} ${item.unit}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading available items:', error);
                showAlert('Error loading available items', 'error');
            }
        }

        function closeCreateBasketModal() {
            document.getElementById('create-basket-modal').style.display = 'none';
            document.getElementById('create-basket-form').reset();
        }

        async function showEditBasketModal(basketId) {
            const basket = smartBaskets.find(b => b.id === basketId);
            if (!basket) return;
            
            document.getElementById('edit-basket-modal').style.display = 'flex';
            document.getElementById('edit-basket-id').value = basket.id;
            document.getElementById('edit-basket-name').value = basket.basket_name;
            document.getElementById('edit-auto-reorder').checked = basket.auto_reorder_enabled;
            document.getElementById('edit-reorder-threshold').value = basket.reorder_threshold_days;
            document.getElementById('edit-min-quantity').value = basket.min_quantity;
            document.getElementById('edit-max-quantity').value = basket.max_quantity;
        }

        function closeEditBasketModal() {
            document.getElementById('edit-basket-modal').style.display = 'none';
        }

        async function checkAutoAddItems() {
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${currentUserId}/check-auto-add`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.auto_added_items.length > 0) {
                    showAlert(`ü§ñ Auto-added ${result.auto_added_items.length} items to your cart!`, 'success');
                    loadSmartBaskets(); // Refresh the list
                } else {
                    showAlert('No items needed auto-adding at this time', 'info');
                }
                
            } catch (error) {
                console.error('Error checking auto-add:', error);
                showAlert('Error checking auto-add items', 'error');
            }
        }

        // Form submissions
        document.getElementById('create-basket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                item_id: parseInt(document.getElementById('basket-item').value),
                basket_name: document.getElementById('basket-name').value,
                reorder_threshold_days: parseFloat(document.getElementById('reorder-threshold').value),
                min_quantity: parseFloat(document.getElementById('min-quantity').value),
                max_quantity: parseFloat(document.getElementById('max-quantity').value)
            };
            
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Smart basket created successfully! üõçÔ∏è', 'success');
                    closeCreateBasketModal();
                    loadSmartBaskets();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error creating smart basket', 'error');
                }
            } catch (error) {
                console.error('Error creating smart basket:', error);
                showAlert('Error creating smart basket', 'error');
            }
        });

        document.getElementById('edit-basket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const basketId = document.getElementById('edit-basket-id').value;
            const formData = {
                basket_name: document.getElementById('edit-basket-name').value,
                auto_reorder_enabled: document.getElementById('edit-auto-reorder').checked,
                reorder_threshold_days: parseFloat(document.getElementById('edit-reorder-threshold').value),
                min_quantity: parseFloat(document.getElementById('edit-min-quantity').value),
                max_quantity: parseFloat(document.getElementById('edit-max-quantity').value)
            };
            
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${basketId}?user_id=${currentUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Smart basket updated successfully! ‚úèÔ∏è', 'success');
                    closeEditBasketModal();
                    loadSmartBaskets();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error updating smart basket', 'error');
                }
            } catch (error) {
                console.error('Error updating smart basket:', error);
                showAlert('Error updating smart basket', 'error');
            }
        });

        async function deleteSmartBasket(basketId) {
            if (!confirm('Are you sure you want to delete this smart basket? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${basketId}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Smart basket deleted successfully! üóëÔ∏è', 'success');
                    loadSmartBaskets();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error deleting smart basket', 'error');
                }
            } catch (error) {
                console.error('Error deleting smart basket:', error);
                showAlert('Error deleting smart basket', 'error');
            }
        }

        async function viewBasketHistory(basketId) {
            try {
                const response = await fetch(`${API_BASE}/smart-baskets/${basketId}/history?user_id=${currentUserId}`);
                const history = await response.json();
                
                let historyHtml = `
                    <div style="background: white; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">üìä Basket History</h4>
                `;
                
                if (history.length === 0) {
                    historyHtml += '<p style="color: #666; text-align: center; padding: 20px;">No history available yet</p>';
                } else {
                    history.forEach(entry => {
                        const actionIcon = entry.action === 'auto_added' ? 'ü§ñ' : 
                                         entry.action === 'created' ? '‚ûï' : 
                                         entry.action === 'updated' ? '‚úèÔ∏è' : 'üóëÔ∏è';
                        
                        historyHtml += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${actionIcon} ${entry.action.replace('_', ' ').toUpperCase()}</div>
                                    <div style="font-size: 0.9rem; color: #666;">${entry.reason}</div>
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: #888;">
                                    ${new Date(entry.created_at).toLocaleDateString()}
                                    ${entry.quantity_added > 0 ? `<br>+${entry.quantity_added}` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                historyHtml += '</div>';
                
                // Show in a modal or alert
                showAlert(historyHtml, 'info');
                
            } catch (error) {
                console.error('Error loading basket history:', error);
                showAlert('Error loading basket history', 'error');
            }
        }
     </script>
 </body>
 </html>
